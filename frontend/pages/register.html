<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - KSP POLRI</title>

    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://cdn.jsdelivr.net; img-src 'self' data:">

    <link rel="stylesheet" href="../assets/css/bootstrap-custom.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .register-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 600px;
            overflow: hidden;
        }

        .register-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .register-header h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        .register-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .register-body {
            padding: 30px;
        }

        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .nav-tab:hover {
            color: #1e3c72;
        }

        .nav-tab.active {
            color: #1e3c72;
            border-bottom-color: #1e3c72;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .address-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .address-section h5 {
            margin: 0 0 15px 0;
            color: #1e3c72;
        }

        .form-group {
            margin-bottom: 15px;
            position: relative;
        }

        .loading-spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1e3c72;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute;
            right: 10px;
            top: 40px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(30, 60, 114, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            border-left: 4px solid;
        }

        .alert-danger {
            background: #fee;
            color: #c33;
            border-left-color: #c33;
        }

        .alert-success {
            background: #efe;
            color: #363;
            border-left-color: #363;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #856404;
        }

        .text-center {
            text-align: center;
        }

        .mt-3 {
            margin-top: 15px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .no-koperasi {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .no-koperasi h3 {
            color: #1e3c72;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <div class="register-container">
        <div class="register-header">
            <h1>ü§ù Daftar KSP POLRI</h1>
            <p>Sistem Simpan Pinjam Polri</p>
        </div>
        <div class="register-body">
            <div id="alertContainer"></div>

            <div id="noKoperasiMessage" class="no-koperasi" style="display: none;">
                <h3>üè¢ Belum Ada Koperasi</h3>
                <p>Silakan daftar koperasi terlebih dahulu sebelum mendaftarkan user.</p>
                <button class="btn btn-primary mt-3" onclick="switchTab('koperasi')">
                    Daftar Koperasi Sekarang
                </button>
            </div>

            <div id="registerFormContainer">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchTab('user')" id="tabUser">
                        üë§ Register User
                    </button>
                    <button class="nav-tab" onclick="switchTab('koperasi')" id="tabKoperasi">
                        üè¢ Register Koperasi
                    </button>
                </div>

                <!-- Tab User -->
                <div id="contentUser" class="tab-content active">
                    <form id="formRegisterUser">
                        <div class="form-group">
                            <label>Koperasi *</label>
                            <select class="form-control" id="userKoperasi" required>
                                <option value="">Pilih Koperasi</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Username *</label>
                            <input type="text" class="form-control" id="userUsername" required minlength="3">
                        </div>

                        <div class="form-group">
                            <label>Password * (min 8 karakter)</label>
                            <input type="password" class="form-control" id="userPassword" required minlength="8">
                        </div>

                        <div class="form-group">
                            <label>Nama Lengkap *</label>
                            <input type="text" class="form-control" id="userNama" required>
                        </div>

                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" id="userEmail">
                        </div>

                        <div class="form-group">
                            <label>Telepon</label>
                            <input type="tel" class="form-control" id="userTelepon">
                        </div>

                        <div class="address-section">
                            <h5>üìç Alamat</h5>

                            <div class="form-group">
                                <label>Provinsi *</label>
                                <select class="form-control" id="userProvinsi" required>
                                    <option value="">Pilih Provinsi</option>
                                </select>
                                <div class="loading-spinner" id="userProvinsiSpinner"></div>
                            </div>

                            <div class="form-group">
                                <label>Kabupaten/Kota *</label>
                                <select class="form-control" id="userKabupaten" required disabled>
                                    <option value="">Pilih Kabupaten/Kota</option>
                                </select>
                                <div class="loading-spinner" id="userKabupatenSpinner"></div>
                            </div>

                            <div class="form-group">
                                <label>Kecamatan *</label>
                                <select class="form-control" id="userKecamatan" required disabled>
                                    <option value="">Pilih Kecamatan</option>
                                </select>
                                <div class="loading-spinner" id="userKecamatanSpinner"></div>
                            </div>

                            <div class="form-group">
                                <label>Desa/Kelurahan *</label>
                                <select class="form-control" id="userDesa" required disabled>
                                    <option value="">Pilih Desa/Kelurahan</option>
                                </select>
                                <div class="loading-spinner" id="userDesaSpinner"></div>
                            </div>

                            <div class="form-group">
                                <label>Alamat Lengkap (Jalan, RT/RW)</label>
                                <textarea class="form-control" id="userAlamatLengkap" rows="2"></textarea>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" id="btnRegisterUser">
                            Daftar User
                        </button>
                    </form>
                </div>

                <!-- Tab Koperasi -->
                <div id="contentKoperasi" class="tab-content">
                    <form id="formRegisterKoperasi">
                        <div class="form-group">
                            <label>Nama Koperasi *</label>
                            <input type="text" class="form-control" id="kopNama" required>
                        </div>

                        <div class="form-group">
                            <label>Kode Koperasi *</label>
                            <input type="text" class="form-control" id="kopKode" required>
                        </div>

                        <div class="form-group">
                            <label>NPWP</label>
                            <input type="text" class="form-control" id="kopNpwp">
                        </div>

                        <div class="form-group">
                            <label>Telepon</label>
                            <input type="tel" class="form-control" id="kopTelepon">
                        </div>

                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" id="kopEmail">
                        </div>

                        <div class="form-group">
                            <label>Nama Pimpinan</label>
                            <input type="text" class="form-control" id="kopPimpinan">
                        </div>

                        <div class="form-group">
                            <label>Jabatan Pimpinan</label>
                            <input type="text" class="form-control" id="kopJabatan" placeholder="Ketua/Direktur">
                        </div>

                        <div class="address-section">
                            <h5>üìç Alamat Koperasi</h5>

                            <div class="form-group">
                                <label>Provinsi *</label>
                                <select class="form-control" id="kopProvinsi" required>
                                    <option value="">Pilih Provinsi</option>
                                </select>
                                <div class="loading-spinner" id="kopProvinsiSpinner"></div>
                            </div>

                            <div class="form-group">
                                <label>Kabupaten/Kota *</label>
                                <select class="form-control" id="kopKabupaten" required disabled>
                                    <option value="">Pilih Kabupaten/Kota</option>
                                </select>
                                <div class="loading-spinner" id="kopKabupatenSpinner"></div>
                            </div>

                            <div class="form-group">
                                <label>Kecamatan *</label>
                                <select class="form-control" id="kopKecamatan" required disabled>
                                    <option value="">Pilih Kecamatan</option>
                                </select>
                                <div class="loading-spinner" id="kopKecamatanSpinner"></div>
                            </div>

                            <div class="form-group">
                                <label>Desa/Kelurahan *</label>
                                <select class="form-control" id="kopDesa" required disabled>
                                    <option value="">Pilih Desa/Kelurahan</option>
                                </select>
                                <div class="loading-spinner" id="kopDesaSpinner"></div>
                            </div>

                            <div class="form-group">
                                <label>Alamat Lengkap (Jalan, RT/RW)</label>
                                <textarea class="form-control" id="kopAlamatLengkap" rows="2"></textarea>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" id="btnRegisterKoperasi">
                            Daftar Koperasi
                        </button>
                    </form>
                </div>

                <div class="text-center mt-3">
                    <p>Sudah punya akun? <a href="login.html">Login di sini</a></p>
                </div>
            </div>
        </div>
    </div>

    <script src="../assets/js/jquery-3.6.0.min.js"></script>
    <script>
        let koperasiExists = false;
        const API_BASE = '../../backend/public/index.php?path=';

        $(document).ready(function () {
            checkKoperasiExists();
            loadProvinsi('user');
            loadProvinsi('kop');
            loadKoperasiList();

            // Address cascade for user
            $('#userProvinsi').change(function () {
                const provinsiId = $(this).val();
                if (provinsiId) {
                    $('#userProvinsiSpinner').show();
                    loadKabupaten('user', provinsiId);
                } else {
                    resetSelect('userKabupaten');
                    $(this).val('');
                }
            });

            $('#userKabupaten').change(function () {
                const kabupatenId = $(this).val();
                if (kabupatenId) {
                    $('#userKabupatenSpinner').show();
                    loadKecamatan('user', kabupatenId);
                } else {
                    resetSelect('userKecamatan');
                    $(this).val('');
                }
            });

            $('#userKecamatan').change(function () {
                const kecamatanId = $(this).val();
                if (kecamatanId) {
                    $('#userKecamatanSpinner').show();
                    loadDesa('user', kecamatanId);
                } else {
                    resetSelect('userDesa');
                    $(this).val('');
                }
            });

            // Address cascade for koperasi
            $('#kopProvinsi').change(function () {
                const provinsiId = $(this).val();
                if (provinsiId) {
                    $('#kopProvinsiSpinner').show();
                    loadKabupaten('kop', provinsiId);
                } else {
                    resetSelect('kopKabupaten');
                    $(this).val('');
                }
            });

            $('#kopKabupaten').change(function () {
                const kabupatenId = $(this).val();
                if (kabupatenId) {
                    $('#kopKabupatenSpinner').show();
                    loadKecamatan('kop', kabupatenId);
                } else {
                    resetSelect('kopKecamatan');
                    $(this).val('');
                }
            });

            $('#kopKecamatan').change(function () {
                const kecamatanId = $(this).val();
                if (kecamatanId) {
                    $('#kopKecamatanSpinner').show();
                    loadDesa('kop', kecamatanId);
                } else {
                    resetSelect('kopDesa');
                    $(this).val('');
                }
            });

            // Form submissions
            $('#formRegisterUser').submit(function (e) {
                e.preventDefault();
                registerUser();
            });

            $('#formRegisterKoperasi').submit(function (e) {
                e.preventDefault();
                registerKoperasi();
            });
        });

        function checkKoperasiExists() {
            $.get(API_BASE + 'auth/checkKoperasiExists', function (data) {
                if (data && data.data && typeof data.data.exists !== 'undefined') {
                    koperasiExists = data.data.exists;
                } else {
                    console.error('API response invalid for checkKoperasiExists:', data);
                    koperasiExists = false; // default to false
                }
                if (!koperasiExists) {
                    $('#noKoperasiMessage').show();
                    $('#registerFormContainer').hide();
                    switchTab('koperasi');
                } else {
                    $('#noKoperasiMessage').hide();
                    $('#registerFormContainer').show();
                }
            }).fail(function () {
                console.error('Failed to check koperasi exists');
                koperasiExists = false;
            });
        }

        function loadKoperasiList() {
            $.get(API_BASE + 'auth/getKoperasiList', function (data) {
                if (data.status) {
                    const select = $('#userKoperasi');
                    select.html('<option value="">Pilih Koperasi</option>');
                    data.data.koperasi.forEach(function (kop) {
                        select.append(`<option value="${kop.id}">${kop.nama_koperasi}</option>`);
                    });
                }
            });
        }

        function switchTab(tab) {
            $('.nav-tab').removeClass('active');
            $('.tab-content').removeClass('active');

            if (tab === 'user') {
                $('#tabUser').addClass('active');
                $('#contentUser').addClass('active');
            } else {
                $('#tabKoperasi').addClass('active');
                $('#contentKoperasi').addClass('active');
            }
        }

        function loadProvinsi(prefix) {
            $.get(API_BASE + 'alamat/provinsi', function (data) {
                if (data.status) {
                    const select = $(`#${prefix}Provinsi`);
                    select.html('<option value="">Pilih Provinsi</option>');
                    data.data.provinsi.forEach(function (p) {
                        select.append(`<option value="${p.id}">${p.nama}</option>`);
                    });
                }
            });
        }

        function loadKabupaten(prefix, provinsiId) {
            if (!provinsiId) return;
            $.get(API_BASE + 'alamat/kabupaten&provinsi_id=' + provinsiId, function (data) {
                if (data.status) {
                    const select = $(`#${prefix}Kabupaten`);
                    select.html('<option value="">Pilih Kabupaten/Kota</option>');
                    data.data.kabupaten.forEach(function (k) {
                        select.append(`<option value="${k.id}">${k.nama}</option>`);
                    });
                    select.prop('disabled', false);
                }
            }).always(function () {
                $(`#${prefix}ProvinsiSpinner`).hide();
            });
        }

        function loadKecamatan(prefix, kabupatenId) {
            if (!kabupatenId) return;
            $.get(API_BASE + 'alamat/kecamatan&kabupaten_id=' + kabupatenId, function (data) {
                if (data.status) {
                    const select = $(`#${prefix}Kecamatan`);
                    select.html('<option value="">Pilih Kecamatan</option>');
                    data.data.kecamatan.forEach(function (k) {
                        select.append(`<option value="${k.id}">${k.nama}</option>`);
                    });
                    select.prop('disabled', false);
                }
            }).always(function () {
                $(`#${prefix}KabupatenSpinner`).hide();
            });
        }

        function loadDesa(prefix, kecamatanId) {
            if (!kecamatanId) return;
            $.get(API_BASE + 'alamat/desa&kecamatan_id=' + kecamatanId, function (data) {
                if (data.status) {
                    const select = $(`#${prefix}Desa`);
                    select.html('<option value="">Pilih Desa/Kelurahan</option>');
                    data.data.desa.forEach(function (d) {
                        select.append(`<option value="${d.id}">${d.nama}</option>`);
                    });
                    select.prop('disabled', false);
                }
            }).always(function () {
                $(`#${prefix}KecamatanSpinner`).hide();
            });
        }

        function resetSelect(id) {
            $(`#${id}`).html('<option value="">Pilih...</option>').prop('disabled', true);
        }

        function registerUser() {
            const btn = $('#btnRegisterUser');
            btn.prop('disabled', true).html('<span class="loading"></span>Mendaftar...');

            const data = {
                koperasi_id: $('#userKoperasi').val(),
                username: $('#userUsername').val(),
                password: $('#userPassword').val(),
                nama_lengkap: $('#userNama').val(),
                email: $('#userEmail').val(),
                telepon: $('#userTelepon').val(),
                provinsi_id: $('#userProvinsi').val(),
                kabupaten_id: $('#userKabupaten').val(),
                kecamatan_id: $('#userKecamatan').val(),
                desa_id: $('#userDesa').val(),
                alamat_lengkap: $('#userAlamatLengkap').val()
            };

            $.post(API_BASE + 'auth/registerUser', data, function (response) {
                if (response.status) {
                    showAlert('success', response.message + '. Silakan <a href="login.html">login</a>.');
                    $('#formRegisterUser')[0].reset();
                } else {
                    showAlert('danger', response.message);
                }
            }, 'json').fail(function () {
                showAlert('danger', 'Terjadi kesalahan. Silakan coba lagi.');
            }).always(function () {
                btn.prop('disabled', false).text('Daftar User');
            });
        }

        function registerKoperasi() {
            const btn = $('#btnRegisterKoperasi');
            btn.prop('disabled', true).html('<span class="loading"></span>Mendaftar...');

            const data = {
                nama_koperasi: $('#kopNama').val(),
                kode_koperasi: $('#kopKode').val(),
                npwp: $('#kopNpwp').val(),
                telepon: $('#kopTelepon').val(),
                email: $('#kopEmail').val(),
                nama_pimpinan: $('#kopPimpinan').val(),
                jabatan_pimpinan: $('#kopJabatan').val(),
                provinsi_id: $('#kopProvinsi').val(),
                kabupaten_id: $('#kopKabupaten').val(),
                kecamatan_id: $('#kopKecamatan').val(),
                desa_id: $('#kopDesa').val(),
                alamat_lengkap: $('#kopAlamatLengkap').val()
            };

            $.post(API_BASE + 'auth/registerKoperasi', data, function (response) {
                if (response.status) {
                    showAlert('success', response.message + '. Silakan register user atau <a href="login.html">login</a>.');
                    $('#formRegisterKoperasi')[0].reset();
                    // Reset address selects
                    resetSelect('kopKabupaten');
                    resetSelect('kopKecamatan');
                    resetSelect('kopDesa');
                    // Reload koperasi check
                    checkKoperasiExists();
                    loadKoperasiList();
                } else {
                    showAlert('danger', response.message);
                }
            }, 'json').fail(function () {
                showAlert('danger', 'Terjadi kesalahan. Silakan coba lagi.');
            }).always(function () {
                btn.prop('disabled', false).text('Daftar Koperasi');
            });
        }

        function showAlert(type, message) {
            const alert = $(`<div class="alert alert-${type}">${message}</div>`);
            $('#alertContainer').html(alert);
            alert.show();
        }
    </script>
</body>

</html> telepon: $('#kopTelepon').val(),
email: $('#kopEmail').val(),
nama_pimpinan: $('#kopPimpinan').val(),
jabatan_pimpinan: $('#kopJabatan').val(),
Prop_desa: $('#kopDesa').val(),
alamat_lengkap: $('#kopAlamatLengkap').val()
};

$.post(API_BASE + 'auth/registerKoperasi', data, function (response) {
if (response.status) {
showAlert('success', response.message + '. Silakan register user atau <a href="login.html">login</a>.');
$('#formRegisterKoperasi')[0].reset();
// Reset address selects
resetSelect('kopKabupaten');
resetSelect('kopKecamatan');
resetSelect('kopDesa');
// Reload koperasi check
checkKoperasiExists();
loadKoperasiList();
} else {
showAlert('danger', response.message);
}
}, 'json').fail(function () {
showAlert('danger', 'Terjadi kesalahan. Silakan coba lagi.');
}).always(function () {
btn.prop('disabled', false).text('Daftar Koperasi');
});
}

function showAlert(type, message) {
const alert = $(`<div class="alert alert-${type}">${message}</div>`);
$('#alertContainer').html(alert);
alert.show();
}
</script>
</body>

</html>
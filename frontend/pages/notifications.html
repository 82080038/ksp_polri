<!DOCTYPE html>
<html>

<head>
    <title>Kelola Notifikasi Email - KSP POLRI</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>
    <h2>Kelola Notifikasi Email</h2>
    <a href="dashboard_pengurus.html">Kembali ke Dashboard</a>

    <h3>Test Konfigurasi Email</h3>
    <form id="testEmailForm">
        <input type="email" name="email" placeholder="Masukkan email untuk test" required>
        <button type="submit">Kirim Email Test</button>
    </form>

    <h3>Notifikasi Tunggakan</h3>
    <button id="processTunggakanBtn">Proses Semua Tunggakan & Kirim Notifikasi</button>
    <div id="tunggakanResult"></div>

    <h3>Broadcast SHU</h3>
    <form id="broadcastShuForm">
        <input type="number" name="tahun" placeholder="Tahun SHU" required>
        <button type="submit">Kirim Notifikasi SHU ke Semua Anggota</button>
    </form>

    <h3>Log Email Terkirim</h3>
    <div class="filters">
        <label>Filter:</label>
        <select id="logFilter">
            <option value="all">Semua</option>
            <option value="unread">Belum dibaca</option>
        </select>
        <button id="markAllReadBtn">Tandai semua dibaca</button>
    </div>
    <div id="emailLogs"></div>

    <script src="../assets/js/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            loadEmailLogs();

            $('#logFilter').on('change', function () {
                loadEmailLogs();
            });

            $('#markAllReadBtn').on('click', function () {
                markAllRead();
            });

            // Test Email
            $('#testEmailForm').on('submit', function (e) {
                e.preventDefault();
                $.post('../backend/public/index.php?path=notification/testEmail', $(this).serialize(), function (data) {
                    alert(data.message);
                }, 'json');
            });

            // Process Tunggakan
            $('#processTunggakanBtn').on('click', function () {
                if (!confirm('Kirim notifikasi ke semua anggota yang menunggak?')) return;

                $('#tunggakanResult').html('<p>Sedang memproses...</p>');
                $.post('../backend/public/index.php?path=notification/processAllTunggakan', function (data) {
                    $('#tunggakanResult').html('<p>' + data.message + '</p>');
                    loadEmailLogs();
                }, 'json');
            });

            // Broadcast SHU
            $('#broadcastShuForm').on('submit', function (e) {
                e.preventDefault();
                if (!confirm('Kirim notifikasi SHU ke semua anggota?')) return;

                const btn = $(this).find('button[type="submit"]');
                btn.prop('disabled', true).text('Mengirim...');

                $.post('../backend/public/index.php?path=notification/broadcastShu', $(this).serialize(), function (data) {
                    alert(data.message);
                    loadEmailLogs();
                }, 'json').fail(function () {
                    alert('Gagal mengirim notifikasi SHU');
                }).always(function () {
                    btn.prop('disabled', false).text('Kirim Notifikasi SHU ke Semua Anggota');
                });
            });

            function loadEmailLogs() {
                $('#emailLogs').html('<p>Memuat log...</p>');
                const filter = $('#logFilter').val();
                $.get(`../backend/public/index.php?path=notification/emailLogs&filter=${filter}`, function (data) {
                    if (data.status) {
                        let html = '<table border="1"><tr><th>Waktu</th><th>Penerima</th><th>Subject</th><th>Status</th></tr>';
                        data.data.forEach(log => {
                            let statusColor = log.status === 'sent' ? 'green' : (log.status === 'failed' ? 'red' : 'orange');
                            html += `<tr><td>${log.sent_at}</td><td>${log.recipient}</td><td>${log.subject}</td><td style="color:${statusColor}">${log.status}</td></tr>`;
                        });
                        html += '</table>';
                        $('#emailLogs').html(html);
                    } else {
                        $('#emailLogs').html('<p>Gagal memuat log.</p>');
                    }
                }, 'json').fail(function () {
                    $('#emailLogs').html('<p>Gagal memuat log (network error).</p>');
                });
            }

            function markAllRead() {
                const btn = $('#markAllReadBtn');
                btn.prop('disabled', true).text('Memproses...');
                $.post('../backend/public/index.php?path=notification/markAllRead', function (data) {
                    alert(data.message || 'Selesai');
                    loadEmailLogs();
                }, 'json').fail(function () {
                    alert('Gagal menandai dibaca.');
                }).always(function () {
                    btn.prop('disabled', false).text('Tandai semua dibaca');
                });
            }
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html>

<head>
    <title>Laporan Keuangan</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>
    <h2>Laporan Keuangan</h2>
    <a href="dashboard_pengurus.html">Kembali ke Dashboard</a>

    <h3>Neraca Saldo</h3>
    <form id="neracaForm">
        <input type="date" name="start_date" placeholder="Tanggal Mulai">
        <input type="date" name="end_date" placeholder="Tanggal Akhir">
        <button type="submit" id="neracaBtn">Tampilkan Neraca Saldo</button>
    </form>
    <div id="neracaContent">Silakan pilih rentang tanggal (opsional) lalu klik tampilkan.</div>

    <h3>Laba Rugi</h3>
    <form id="labaRugiForm">
        <input type="date" name="start_date" required placeholder="Tanggal Mulai">
        <input type="date" name="end_date" required placeholder="Tanggal Akhir">
        <button type="submit" id="labaRugiBtn">Tampilkan Laba Rugi</button>
    </form>
    <div id="labaRugiContent">Isi tanggal mulai & akhir lalu klik tampilkan.</div>

    <script src="../assets/js/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#neracaForm').on('submit', function (e) {
                e.preventDefault();
                const params = $(this).serialize();
                const btn = $('#neracaBtn');
                btn.prop('disabled', true).text('Memuat...');
                $('#neracaContent').html('Memuat data...');

                $.get('../backend/public/index.php?path=accounting/neracaSaldo&' + params, function (data) {
                    if (data.status && data.data.length) {
                        let html = '<table border="1"><tr><th>Kode</th><th>Nama Akun</th><th>Kategori</th><th>Saldo Awal</th><th>Debit</th><th>Kredit</th><th>Saldo Akhir</th></tr>';
                        let totalDebit = 0, totalKredit = 0;
                        data.data.forEach(a => {
                            html += `<tr><td>${a.kode_akun}</td><td>${a.nama_akun}</td><td>${a.kategori}</td><td>${formatRupiah(a.saldo_awal)}</td><td>${formatRupiah(a.total_debit)}</td><td>${formatRupiah(a.total_kredit)}</td><td>${formatRupiah(a.saldo_akhir)}</td></tr>`;
                            totalDebit += parseFloat(a.total_debit || 0);
                            totalKredit += parseFloat(a.total_kredit || 0);
                        });
                        html += `<tr><td colspan="4"><strong>Total</strong></td><td><strong>${formatRupiah(totalDebit)}</strong></td><td><strong>${formatRupiah(totalKredit)}</strong></td><td></td></tr>`;
                        html += '</table>';
                        $('#neracaContent').html(html);
                    } else if (data.status) {
                        $('#neracaContent').html('Data neraca saldo kosong untuk rentang ini.');
                    } else {
                        $('#neracaContent').html(data.message || 'Gagal memuat neraca saldo');
                    }
                }, 'json').fail(function () {
                    $('#neracaContent').html('Gagal memuat neraca saldo.');
                }).always(function () {
                    btn.prop('disabled', false).text('Tampilkan Neraca Saldo');
                });
            });

            $('#labaRugiForm').on('submit', function (e) {
                e.preventDefault();
                const params = $(this).serialize();
                const btn = $('#labaRugiBtn');
                btn.prop('disabled', true).text('Memuat...');
                $('#labaRugiContent').html('Memuat data...');

                $.get('../backend/public/index.php?path=accounting/labaRugi&' + params, function (data) {
                    if (data.status) {
                        let html = '<h4>Pendapatan</h4><table border="1"><tr><th>Kode</th><th>Nama Akun</th><th>Jumlah</th></tr>';
                        (data.data.pendapatan || []).forEach(p => {
                            html += `<tr><td>${p.kode_akun}</td><td>${p.nama_akun}</td><td>${formatRupiah(p.saldo)}</td></tr>`;
                        });
                        html += `<tr><td colspan="2"><strong>Total Pendapatan</strong></td><td><strong>${formatRupiah(data.data.total_pendapatan || 0)}</strong></td></tr>`;
                        html += '</table>';

                        html += '<h4>Beban</h4><table border="1"><tr><th>Kode</th><th>Nama Akun</th><th>Jumlah</th></tr>';
                        (data.data.beban || []).forEach(b => {
                            html += `<tr><td>${b.kode_akun}</td><td>${b.nama_akun}</td><td>${formatRupiah(b.saldo)}</td></tr>`;
                        });
                        html += `<tr><td colspan="2"><strong>Total Beban</strong></td><td><strong>${formatRupiah(data.data.total_beban || 0)}</strong></td></tr>`;
                        html += '</table>';

                        let labaRugiClass = data.data.laba_rugi >= 0 ? 'profit' : 'loss';
                        let labaRugiText = data.data.laba_rugi >= 0 ? 'Laba Bersih' : 'Rugi Bersih';
                        html += `<h4 class="${labaRugiClass}">${labaRugiText}: ${formatRupiah(Math.abs(data.data.laba_rugi || 0))}</h4>`;

                        $('#labaRugiContent').html(html);
                    } else {
                        $('#labaRugiContent').html(data.message || 'Gagal memuat laporan laba rugi');
                    }
                }, 'json').fail(function () {
                    $('#labaRugiContent').html('Gagal memuat laporan laba rugi.');
                }).always(function () {
                    btn.prop('disabled', false).text('Tampilkan Laba Rugi');
                });
            });

            function formatRupiah(angka) {
                return 'Rp ' + parseFloat(angka || 0).toLocaleString('id-ID');
            }
        });
    </script>
    <style>
        .profit {
            color: green;
        }

        .loss {
            color: red;
        }
    </style>
</body>

</html>
<!DOCTYPE html>
<html>

<head>
    <title>Multi-Factor Authentication - KSP POLRI</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .mfa-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .mfa-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .mfa-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-enabled {
            background: #4caf50;
        }

        .status-disabled {
            background: #f44336;
        }

        .mfa-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .mfa-option {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mfa-option:hover {
            border-color: #2196f3;
            background: #f8f9fa;
        }

        .mfa-option.selected {
            border-color: #2196f3;
            background: #e3f2fd;
        }

        .mfa-option .icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .mfa-option h4 {
            margin: 10px 0 5px 0;
        }

        .backup-codes {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .backup-codes h4 {
            margin-top: 0;
            color: #856404;
        }

        .code-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .backup-code {
            background: white;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-family: monospace;
            font-weight: bold;
            border: 1px solid #ddd;
        }

        .qr-container {
            text-align: center;
            margin: 20px 0;
        }

        .qr-code {
            max-width: 200px;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .verification-form {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .verification-form input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 18px;
            text-align: center;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }

        .btn-mfa {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-mfa:hover {
            background: #1976d2;
        }

        .btn-mfa.danger {
            background: #f44336;
        }

        .btn-mfa.danger:hover {
            background: #d32f2f;
        }

        .admin-section {
            border-top: 2px solid #2196f3;
            padding-top: 20px;
            margin-top: 30px;
        }

        .user-mfa-table {
            width: 100%;
            border-collapse: collapse;
        }

        .user-mfa-table th,
        .user-mfa-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .user-mfa-table th {
            background: #f5f5f5;
        }

        .mfa-enabled {
            color: #4caf50;
            font-weight: bold;
        }

        .mfa-disabled {
            color: #f44336;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="mfa-container">
        <h2>Multi-Factor Authentication (MFA)</h2>
        <a href="dashboard_anggota.html">Kembali ke Dashboard</a>

        <!-- MFA Status -->
        <div class="mfa-section">
            <h3>Status MFA</h3>
            <div class="mfa-status">
                <div class="status-indicator status-disabled" id="mfaStatusIndicator"></div>
                <span id="mfaStatusText">MFA tidak aktif</span>
            </div>
            <div id="mfaActions">
                <button class="btn-mfa" onclick="enableMFA()">Aktifkan MFA</button>
            </div>
        </div>

        <!-- MFA Setup -->
        <div class="mfa-section" id="mfaSetup" style="display:none;">
            <h3>Setup Multi-Factor Authentication</h3>

            <div class="mfa-options">
                <div class="mfa-option" data-type="email" onclick="selectMFAType('email')">
                    <div class="icon">ðŸ“§</div>
                    <h4>Email</h4>
                    <p>Kode verifikasi dikirim ke email Anda</p>
                </div>
                <div class="mfa-option" data-type="authenticator" onclick="selectMFAType('authenticator')">
                    <div class="icon">ðŸ“±</div>
                    <h4>Authenticator App</h4>
                    <p>Gunakan Google Authenticator atau app serupa</p>
                </div>
            </div>

            <div id="emailSetup" style="display:none;">
                <p>Klik tombol di bawah untuk mengirim kode verifikasi ke email Anda.</p>
                <button class="btn-mfa" onclick="sendEmailChallenge()" id="emailChallengeBtn">Kirim Kode Email</button>
            </div>

            <div id="authenticatorSetup" style="display:none;">
                <p>1. Install aplikasi authenticator (Google Authenticator, Authy, dll)</p>
                <p>2. Scan QR code berikut dengan aplikasi authenticator:</p>
                <div class="qr-container">
                    <img id="qrCode" src="" alt="QR Code" class="qr-code" style="display:none;">
                    <p id="qrLoading">Loading QR code...</p>
                </div>
                <p>3. Masukkan kode 6 digit dari aplikasi:</p>
            </div>

            <div class="verification-form" id="verificationForm" style="display:none;">
                <h4>Verifikasi Kode</h4>
                <input type="text" id="verificationCode" placeholder="Masukkan kode 6 digit" maxlength="6">
                <button class="btn-mfa" onclick="verifyMFA()" id="verifyBtn">Verifikasi</button>
            </div>
        </div>

        <!-- Backup Codes -->
        <div class="mfa-section" id="backupCodesSection" style="display:none;">
            <h3>Kode Cadangan (Backup Codes)</h3>
            <p>Kode cadangan dapat digunakan jika Anda kehilangan akses ke email atau aplikasi authenticator.</p>
            <p><strong>PENTING:</strong> Simpan kode ini di tempat yang aman. Setiap kode hanya dapat digunakan sekali.
            </p>

            <button class="btn-mfa" onclick="generateBackupCodes()">Generate Kode Cadangan Baru</button>

            <div id="backupCodes" class="backup-codes" style="display:none;">
                <h4>Kode Cadangan Anda:</h4>
                <div id="codeGrid" class="code-grid"></div>
                <p style="margin-top:15px; color:#856404;">
                    <strong>Simpan kode ini dengan aman!</strong> Kode akan hilang setelah Anda menutup halaman ini.
                </p>
            </div>
        </div>

        <!-- Admin Section -->
        <div class="admin-section" id="adminSection" style="display:none;">
            <h3>Manajemen MFA (Admin)</h3>

            <button class="btn-mfa" onclick="loadMFASettings()">Refresh Data</button>

            <table class="user-mfa-table" id="userMFATable">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>MFA Status</th>
                        <th>Type</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="../assets/js/jquery-3.6.0.min.js"></script>
    <script>
        let selectedMFAType = null;

        $(document).ready(function () {
            loadMFAStatus();

            // Check if user is admin
            if ('<?php echo $_SESSION["role"] ?? ""; ?>' === 'pengurus') {
                $('#adminSection').show();
                loadMFASettings();
            }
        });

        function loadMFAStatus() {
            $('#mfaStatusText').text('Memuat status...');
            $.get('../backend/public/index.php?path=mfa/status', function (data) {
                if (data.status) {
                    if (data.data.enabled) {
                        $('#mfaStatusIndicator').removeClass('status-disabled').addClass('status-enabled');
                        $('#mfaStatusText').text('MFA aktif (' + data.data.type + ')');
                        $('#mfaActions').html('<button class="btn-mfa danger" onclick="disableMFA()">Nonaktifkan MFA</button>');
                        $('#backupCodesSection').show();
                    } else {
                        $('#mfaStatusIndicator').removeClass('status-enabled').addClass('status-disabled');
                        $('#mfaStatusText').text('MFA tidak aktif');
                        $('#mfaActions').html('<button class="btn-mfa" onclick="enableMFA()">Aktifkan MFA</button>');
                        $('#backupCodesSection').hide();
                    }
                } else {
                    $('#mfaStatusText').text('Gagal memuat status MFA');
                }
            }, 'json').fail(function () {
                $('#mfaStatusText').text('Gagal memuat status MFA');
            });
        }

        function enableMFA() {
            $('#mfaSetup').show();
            $('#mfaActions').hide();
            $('#verificationForm').hide();
            $('#emailSetup, #authenticatorSetup').hide();
        }

        function selectMFAType(type) {
            selectedMFAType = type;

            $('.mfa-option').removeClass('selected');
            $(`.mfa-option[data-type="${type}"]`).addClass('selected');

            $('#emailSetup').hide();
            $('#authenticatorSetup').hide();
            $('#verificationForm').hide();

            if (type === 'email') {
                $('#emailSetup').show();
            } else if (type === 'authenticator') {
                $('#authenticatorSetup').show();
                loadQRCode();
            }
        }

        function sendEmailChallenge() {
            const btn = $('#emailChallengeBtn');
            btn.prop('disabled', true).text('Mengirim...');
            $.post('../backend/public/index.php?path=mfa/sendChallenge', { type: 'email' }, function (data) {
                if (data.status) {
                    alert('Kode verifikasi telah dikirim ke email Anda');
                    $('#verificationForm').show();
                } else {
                    alert('Gagal mengirim kode: ' + (data.message || ''));
                }
            }, 'json').fail(function () {
                alert('Gagal mengirim kode');
            }).always(function () {
                btn.prop('disabled', false).text('Kirim Kode Email');
            });
        }

        function loadQRCode() {
            $('#qrLoading').show().text('Loading QR code...');
            $('#qrCode').hide();

            $.get('../backend/public/index.php?path=mfa/qrCode', function (data) {
                if (data.status) {
                    $('#qrCode').attr('src', 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(data.data.qr_url));
                    $('#qrLoading').hide();
                    $('#qrCode').show();
                    $('#verificationForm').show();
                } else {
                    $('#qrLoading').text('Gagal memuat QR code');
                }
            }, 'json').fail(function () {
                $('#qrLoading').text('Gagal memuat QR code');
            });
        }

        function verifyMFA() {
            const code = $('#verificationCode').val();
            if (!code || code.length !== 6) {
                alert('Masukkan kode 6 digit yang valid');
                return;
            }
            const btn = $('#verifyBtn');
            btn.prop('disabled', true).text('Memverifikasi...');

            $.post('../backend/public/index.php?path=mfa/verify', {
                code: code,
                type: selectedMFAType
            }, function (data) {
                if (data.status) {
                    alert('MFA berhasil diaktifkan!');
                    $('#mfaSetup').hide();
                    loadMFAStatus();
                    generateBackupCodes();
                } else {
                    alert('Kode verifikasi salah: ' + (data.message || ''));
                }
            }, 'json').fail(function () {
                alert('Gagal memverifikasi MFA');
            }).always(function () {
                btn.prop('disabled', false).text('Verifikasi');
            });
        }

        function disableMFA() {
            if (!confirm('Apakah Anda yakin ingin menonaktifkan MFA? Ini akan mengurangi keamanan akun Anda.')) {
                return;
            }

            $.post('../backend/public/index.php?path=mfa/disable', function (data) {
                if (data.status) {
                    alert('MFA berhasil dinonaktifkan');
                    loadMFAStatus();
                } else {
                    alert('Gagal menonaktifkan MFA: ' + data.message);
                }
            }, 'json');
        }

        function generateBackupCodes() {
            $.post('../backend/public/index.php?path=mfa/backupCodes', function (data) {
                if (data.status) {
                    const codes = data.data.backup_codes;
                    let html = '';
                    codes.forEach(code => {
                        html += `<div class="backup-code">${code}</div>`;
                    });
                    $('#codeGrid').html(html);
                    $('#backupCodes').show();
                } else {
                    alert('Gagal generate backup codes: ' + data.message);
                }
            }, 'json');
        }

        function loadMFASettings() {
            $.get('../backend/public/index.php?path=mfa/settings', function (data) {
                if (data.status) {
                    let html = '';
                    data.data.users.forEach(user => {
                        const mfaStatus = user.mfa_enabled ? '<span class="mfa-enabled">Aktif</span>' : '<span class="mfa-disabled">Tidak Aktif</span>';
                        const mfaType = user.mfa_type || '-';
                        const actions = user.mfa_enabled ?
                            `<button class="btn-mfa danger" onclick="forceDisableMFA(${user.id})">Nonaktifkan</button>` :
                            `<button class="btn-mfa" onclick="forceEnableMFA(${user.id})">Aktifkan</button>`;

                        html += `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td>${mfaStatus}</td>
                                <td>${mfaType}</td>
                                <td>${actions}</td>
                            </tr>
                        `;
                    });
                    $('#userMFATable tbody').html(html);
                }
            }, 'json');
        }

        function forceEnableMFA(userId) {
            const type = prompt('Pilih tipe MFA (email/authenticator):', 'email');
            if (!type) return;

            $.post('../backend/public/index.php?path=mfa/forceEnable', {
                user_id: userId,
                type: type
            }, function (data) {
                if (data.status) {
                    alert('MFA berhasil diaktifkan untuk user');
                    loadMFASettings();
                } else {
                    alert('Gagal mengaktifkan MFA: ' + data.message);
                }
            }, 'json');
        }

        function forceDisableMFA(userId) {
            if (!confirm('Nonaktifkan MFA untuk user ini?')) return;

            $.post('../backend/public/index.php?path=mfa/forceDisable', {
                user_id: userId
            }, function (data) {
                if (data.status) {
                    alert('MFA berhasil dinonaktifkan untuk user');
                    loadMFASettings();
                } else {
                    alert('Gagal menonaktifkan MFA: ' + data.message);
                }
            }, 'json');
        }
    </script>
</body>

</html>
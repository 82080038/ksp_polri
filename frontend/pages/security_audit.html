<!DOCTYPE html>
<html>

<head>
    <title>Security Audit Dashboard - KSP POLRI</title>
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://cdn.jsdelivr.net; img-src 'self' data:">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .security-dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .security-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .security-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #2196F3;
        }

        .security-card.critical {
            border-left-color: #f44336;
        }

        .security-card.high {
            border-left-color: #ff9800;
        }

        .security-card.medium {
            border-left-color: #ffeb3b;
        }

        .security-card.low {
            border-left-color: #4caf50;
        }

        .security-card h3 {
            margin-top: 0;
            color: #333;
        }

        .security-card .count {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .audit-results {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .vulnerability-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .vulnerability-item.critical {
            border-left: 4px solid #f44336;
        }

        .vulnerability-item.high {
            border-left: 4px solid #ff9800;
        }

        .vulnerability-item.medium {
            border-left: 4px solid #ffeb3b;
        }

        .vulnerability-item.low {
            border-left: 4px solid #4caf50;
        }

        .vulnerability-item .severity {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .severity.critical {
            background: #ffebee;
            color: #f44336;
        }

        .severity.high {
            background: #fff3e0;
            color: #ff9800;
        }

        .severity.medium {
            background: #fffde7;
            color: #ffeb3b;
        }

        .severity.low {
            background: #e8f5e9;
            color: #4caf50;
        }

        .settings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .settings-table th,
        .settings-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .settings-table th {
            background: #f5f5f5;
            font-weight: bold;
        }

        .setting-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .btn-run-audit {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-run-audit:hover {
            background: #d32f2f;
        }

        .btn-save {
            background: #4caf50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .btn-save:hover {
            background: #388e3c;
        }

        .audit-log-table {
            width: 100%;
            border-collapse: collapse;
        }

        .audit-log-table th,
        .audit-log-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .audit-log-table th {
            background: #f5f5f5;
        }
    </style>
</head>

<body>
    <div class="security-dashboard">
        <h2>Security Audit Dashboard</h2>
        <a href="dashboard_pengurus.html">Kembali ke Dashboard</a>

        <!-- Quick Stats -->
        <div class="security-cards">
            <div class="security-card">
                <h3>Total Vulnerabilities</h3>
                <div class="count" id="totalVulnerabilities">0</div>
                <p>Detected in last audit</p>
            </div>
            <div class="security-card">
                <h3>Critical Issues</h3>
                <div class="count" id="criticalCount">0</div>
                <p>Require immediate attention</p>
            </div>
            <div class="security-card">
                <h3>High Priority</h3>
                <div class="count" id="highCount">0</div>
                <p>Should be fixed soon</p>
            </div>
            <div class="security-card">
                <h3>Last Audit</h3>
                <div class="count" id="lastAuditTime">-</div>
                <p>When audit was last run</p>
            </div>
        </div>

        <!-- Run Audit Button -->
        <div class="audit-results">
            <h3>Run Security Audit</h3>
            <p>Click the button below to run a comprehensive security audit of the system.</p>
            <button id="runAuditBtn" class="btn-run-audit">Run Security Audit</button>
            <div id="auditProgress" style="display:none; margin-top:10px;">
                <p>Running security audit... Please wait.</p>
                <div style="width:100%; height:20px; background:#eee; border-radius:10px;">
                    <div id="progressBar"
                        style="width:0%; height:100%; background:#2196F3; border-radius:10px; transition:width 0.5s;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Audit Results -->
        <div class="audit-results">
            <h3>Audit Results</h3>
            <div id="auditResults">No audit results available. Run an audit to see results.</div>
        </div>

        <!-- Security Settings -->
        <div class="audit-results">
            <h3>Security Settings</h3>
            <table class="settings-table">
                <thead>
                    <tr>
                        <th>Setting</th>
                        <th>Value</th>
                        <th>Description</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="settingsTable">
                    <tr>
                        <td colspan="4">Loading settings...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Audit Logs -->
        <div class="audit-results">
            <h3>Recent Security Audit Logs</h3>
            <table class="audit-log-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Severity</th>
                        <th>Description</th>
                        <th>IP Address</th>
                    </tr>
                </thead>
                <tbody id="auditLogsTable">
                    <tr>
                        <td colspan="5">Loading logs...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="../assets/js/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            loadSecuritySettings();
            loadAuditLogs();

            // Run audit
            $('#runAuditBtn').on('click', function () {
                runSecurityAudit();
            });
        });

        function runSecurityAudit() {
            if (!confirm('Are you sure you want to run a security audit? This may take a few moments.')) {
                return;
            }

            $('#runAuditBtn').prop('disabled', true);
            $('#auditProgress').show();
            $('#progressBar').css('width', '0%');

            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                $('#progressBar').css('width', progress + '%');
                if (progress >= 90) {
                    clearInterval(progressInterval);
                }
            }, 200);

            $.post('../../backend/public/index.php?path=security/runAudit', function (data) {
                clearInterval(progressInterval);
                $('#progressBar').css('width', '100%');
                $('#runAuditBtn').prop('disabled', false);

                setTimeout(() => {
                    $('#auditProgress').hide();
                    if (data.status) {
                        displayAuditResults(data.data);
                        loadAuditLogs();
                        updateStats(data.data);
                    } else {
                        alert('Audit failed: ' + (data.message || 'Unknown error'));
                    }
                }, 1000);
            }, 'json').fail(function () {
                clearInterval(progressInterval);
                $('#auditProgress').hide();
                $('#runAuditBtn').prop('disabled', false);
                alert('Audit failed to complete');
            });
        }

        function displayAuditResults(results) {
            let html = '';

            if (results.total_vulnerabilities === 0) {
                html = '<p style="color: green; font-weight: bold;">✅ No vulnerabilities detected!</p>';
            } else {
                html = '<p style="color: red; font-weight: bold;">⚠️ ' + results.total_vulnerabilities + ' vulnerabilities found:</p>';

                for (const [category, vulnerabilities] of Object.entries(results.results)) {
                    if (vulnerabilities.length > 0) {
                        html += '<h4>' + category.replace('_', ' ').toUpperCase() + '</h4>';
                        vulnerabilities.forEach(vuln => {
                            html += `
                                <div class="vulnerability-item ${vuln.severity}">
                                    <div class="severity ${vuln.severity}">${vuln.severity}</div>
                                    <strong>${vuln.description}</strong>
                                    ${vuln.payload ? '<br><small>Payload: ' + vuln.payload + '</small>' : ''}
                                </div>
                            `;
                        });
                    }
                }
            }

            $('#auditResults').html(html);
        }

        function updateStats(data) {
            $('#totalVulnerabilities').text(data.total_vulnerabilities || 0);

            let critical = 0, high = 0;
            for (const [category, vulnerabilities] of Object.entries(data.results)) {
                vulnerabilities.forEach(vuln => {
                    if (vuln.severity === 'critical') critical++;
                    if (vuln.severity === 'high') high++;
                });
            }

            $('#criticalCount').text(critical);
            $('#highCount').text(high);
            $('#lastAuditTime').text(new Date().toLocaleString('id-ID'));
        }

        function loadSecuritySettings() {
            $('#settingsTable').html('<tr><td colspan="4">Loading settings...</td></tr>');
            $.get('../../backend/public/index.php?path=security/getSettings', function (data) {
                if (data.status) {
                    let html = '';
                    data.data.forEach(setting => {
                        html += `
                            <tr>
                                <td><strong>${setting.setting_key}</strong></td>
                                <td>
                                    <input type="text" class="setting-input" data-key="${setting.setting_key}" value="${setting.setting_value}">
                                </td>
                                <td>${setting.description}</td>
                                <td>
                                    <button class="btn-save" data-key="${setting.setting_key}" onclick="saveSetting('${setting.setting_key}', this)">Save</button>
                                </td>
                            </tr>
                        `;
                    });
                    $('#settingsTable').html(html);
                } else {
                    $('#settingsTable').html('<tr><td colspan="4">Failed to load settings</td></tr>');
                }
            }, 'json').fail(function () {
                $('#settingsTable').html('<tr><td colspan="4">Failed to load settings (network error)</td></tr>');
            });
        }

        function saveSetting(key, btn) {
            const value = $(`.setting-input[data-key="${key}"]`).val();

            if (value === undefined) {
                alert('Nilai setting tidak ditemukan');
                return;
            }

            const $btn = $(btn);
            $btn.prop('disabled', true).text('Saving...');

            $.post('../../backend/public/index.php?path=security/updateSetting', {
                key: key,
                value: value
            }, function (data) {
                if (data.status) {
                    alert('Setting saved successfully');
                } else {
                    alert('Failed to save setting: ' + (data.message || ''));
                }
            }, 'json').fail(function () {
                alert('Failed to save setting: network error');
            }).always(function () {
                $btn.prop('disabled', false).text('Save');
            });
        }

        function loadAuditLogs() {
            $('#auditLogsTable').html('<tr><td colspan="5">Loading logs...</td></tr>');
            $.get('../../backend/public/index.php?path=security/getAuditLogs&limit=20', function (data) {
                if (data.status && data.data.logs.length > 0) {
                    let html = '';
                    data.data.logs.forEach(log => {
                        const time = new Date(log.detected_at).toLocaleString('id-ID');
                        html += `
                            <tr>
                                <td>${time}</td>
                                <td>${log.vulnerability_type}</td>
                                <td><span class="severity ${log.severity}">${log.severity}</span></td>
                                <td>${log.description}</td>
                                <td>${log.ip_address}</td>
                            </tr>
                        `;
                    });
                    $('#auditLogsTable').html(html);
                } else {
                    $('#auditLogsTable').html('<tr><td colspan="5">No audit logs available</td></tr>');
                }
            }, 'json').fail(function () {
                $('#auditLogsTable').html('<tr><td colspan="5">Failed to load logs (network error)</td></tr>');
            });
        }

        // Make functions global for onclick handlers
        window.saveSetting = saveSetting;
    </script>
</body>

</html>
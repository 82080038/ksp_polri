# ğŸ“˜ BLUEPRINT PROYEK APLIKASI KSP PERSONEL POLRI

## 1. Gambaran Umum

Aplikasi **KSP Personel POLRI** adalah sistem informasi koperasi simpan pinjam yang dirancang khusus untuk lingkungan internal Kepolisian Republik Indonesia. Sistem ini menyesuaikan **struktur keanggotaan, pola gaji, mutasi dinas, dan mekanisme RAT** yang khas di POLRI.

Tujuan utama:

* Transparansi keuangan
* Akuntabilitas pengurus
* Kemudahan anggota
* Kesiapan audit internal

---

## 2. Ruang Lingkup Fitur

### 2.1 Keanggotaan

* Registrasi anggota berbasis **NRP**
* Status dinas (aktif, mutasi, pensiun, keluar)
* Riwayat anggota tidak pernah dihapus

### 2.2 Simpanan

* Simpanan pokok (1x)
* Simpanan wajib (bulanan / potong gaji)
* Simpanan sukarela

### 2.3 Pinjaman

* Pengajuan pinjaman
* Validasi otomatis (status dinas, plafon, tenor)
* Persetujuan pengurus
* Jadwal angsuran otomatis

### 2.4 Angsuran

* Pembayaran angsuran
* Deteksi tunggakan
* Monitoring pinjaman aktif

### 2.5 SHU

* Perhitungan SHU otomatis per tahun buku
* Distribusi SHU per anggota
* Simulasi sebelum RAT

### 2.6 RAT

* Penyusunan laporan RAT
* Pengesahan SHU
* Penguncian data tahun buku

### 2.7 Audit & Keamanan

* Audit log semua perubahan data
* Hak akses berbasis role
* Data historis immutable

---

## 3. Struktur Peran (Role)

| Role     | Deskripsi                                 |
| -------- | ----------------------------------------- |
| Anggota  | Melihat data pribadi & pengajuan pinjaman |
| Pengurus | Mengelola operasional koperasi            |
| Pengawas | Audit & monitoring (read-only)            |
| Admin    | Teknis sistem & konfigurasi               |

---

## 4. Arsitektur Sistem

### 4.1 Arsitektur Umum

```
Frontend (Web)
   â†“ API
Backend (Node.js / Express)
   â†“
Database (MySQL)
```

### 4.2 Prinsip Arsitektur

* Modular
* Multi-tahun buku
* Audit-first design
* Soft delete

---

## 5. Struktur Database (Ringkas)

Entitas utama:

* anggota
* users
* roles
* simpanan
* pinjaman
* angsuran
* transaksi_keuangan
* shu_rekap
* shu_anggota
* rat
* audit_log

Relasi utama:

```
anggota -> simpanan
anggota -> pinjaman -> angsuran
anggota -> shu_anggota -> shu_rekap -> rat
users -> roles
users -> audit_log
```

---

## 6. Struktur Folder Backend

```
backend/
â”œâ”€â”€ app.js
â”œâ”€â”€ config/
â”œâ”€â”€ routes/
â”œâ”€â”€ controllers/
â”œâ”€â”€ services/
â”œâ”€â”€ models/
â”œâ”€â”€ middlewares/
â”œâ”€â”€ migrations/
â””â”€â”€ utils/
```

---

## 7. API Utama (Ringkas)

### Auth

* POST /api/login

### Anggota

* GET /api/anggota
* POST /api/anggota
* PATCH /api/anggota/:id/status

### Simpanan

* POST /api/simpanan
* GET /api/simpanan/anggota/:id

### Pinjaman

* POST /api/pinjaman
* POST /api/pinjaman/:id/approve

### Angsuran

* POST /api/angsuran/bayar

### SHU

* POST /api/shu/hitung
* GET /api/shu/tahun/:tahun

### RAT

* POST /api/rat
* POST /api/rat/:id/sahkan

---

## 8. Flow Frontend (Ringkas)

### Anggota

Login â†’ Dashboard â†’ Simpanan â†’ Pinjaman â†’ SHU â†’ Profil

### Pengurus

Dashboard â†’ Anggota â†’ Simpanan â†’ Pinjaman â†’ SHU â†’ RAT

### Pengawas

Dashboard â†’ Laporan â†’ Audit Log â†’ RAT

### Admin

User â†’ Parameter â†’ Tahun Buku â†’ Backup

---

## 9. Keamanan & Audit

* JWT Authentication
* Role-based Access Control
* Semua perubahan data dicatat di audit_log

---

## 10. Roadmap Pengembangan

### Tahap 1 (Core)

* Keanggotaan
* Simpanan
* Pinjaman

### Tahap 2 (Governance)

* SHU
* RAT
* Audit

### Tahap 3 (Lanjutan)

* Dashboard analitik
* Notifikasi tunggakan
* Mobile App

---

## 11. Penutup

Blueprint ini dirancang agar aplikasi KSP Personel POLRI:

* Siap produksi
* Tidak kehilangan fitur penting
* Mudah dikembangkan jangka panjang
* Aman secara organisasi & audit

---

ğŸ“Œ *Dokumen ini menjadi acuan utama pengembangan. Semua perubahan sistem harus merujuk pada blueprint ini.*

---

## 12. Middleware Keamanan & Role Enforcement

### 12.1 Authentication

* JWT-based authentication
* Token berisi: user_id, role, anggota_id

### 12.2 Authorization

Setiap endpoint divalidasi oleh middleware:

* authMiddleware â†’ validasi token
* roleMiddleware â†’ validasi hak akses

Contoh aturan:

* Anggota hanya boleh akses data sendiri
* Pengawas read-only
* Pengurus transaksi

---

## 13. Query Laporan Penting

### 13.1 Laporan Bulanan

* Simpanan per bulan
* Angsuran masuk
* Tunggakan

### 13.2 Laporan Tahunan

* Neraca
* Perhitungan SHU
* Rekap pinjaman

### 13.3 Laporan RAT

* Laporan pengurus
* Laporan pengawas
* Distribusi SHU per anggota

---

## 14. Simulasi 1 Tahun Operasional KSP

Skenario:

* 100 anggota aktif
* 80 anggota simpanan wajib rutin
* 40 anggota pinjaman aktif
* 5 anggota mutasi

Hasil simulasi:

* Sistem tetap konsisten
* SHU terhitung otomatis
* Anggota mutasi tetap dapat SHU proporsional

---

## 15. SOP Penggunaan Sistem

### 15.1 SOP Anggota

* Login & cek saldo
* Ajukan pinjaman
* Pantau angsuran

### 15.2 SOP Pengurus

* Input simpanan bulanan
* Approval pinjaman
* Tutup buku

### 15.3 SOP Pengawas

* Audit laporan
* Cek log transaksi

---

## 16. Checklist Kesiapan Audit

* Data anggota lengkap
* Tidak ada transaksi tanpa log
* SHU terdokumentasi
* RAT tersimpan rapi
* Hak akses sesuai

---

## 17. Roadmap Teknis Lanjutan

* Mobile App (Android)
* Integrasi potong gaji
* Notifikasi WhatsApp
* Dashboard analitik

---

## 18. Status Dokumen

Dokumen ini bersifat:

* Final untuk pengembangan tahap awal
* Living document untuk pengembangan lanjutan

ğŸŸ¢ **STATUS: SIAP PRODUKSI**

---

## 19. Desain UI Konkret (Wireframe per Halaman)

> Desain UI bersifat **fungsional, sederhana, dan formal**, menyesuaikan lingkungan internal POLRI.

### 19.1 Halaman Login

```
+----------------------------------+
|  LOGO KOPERASI POLRI              |
|----------------------------------|
|  Username / NRP                  |
|  Password                        |
|  [ LOGIN ]                       |
+----------------------------------+
```

---

### 19.2 Dashboard Anggota

```
[ Total Simpanan ]   [ Pinjaman Aktif ]
[ Angsuran Bulan Ini ][ Estimasi SHU ]

Menu:
- Simpanan Saya
- Pinjaman Saya
- Ajukan Pinjaman
- SHU & RAT
- Profil (Read-only)
```

---

### 19.3 Dashboard Pengurus

```
[ Total Kas ] [ Pinjaman Berjalan ] [ Tunggakan ]

Menu:
- Data Anggota
- Simpanan Bulanan
- Approval Pinjaman
- Angsuran
- SHU
- RAT
- Laporan
```

---

### 19.4 Dashboard Pengawas

```
[ Ringkasan Keuangan ] [ Status SHU ]

Menu:
- Laporan Keuangan
- Transaksi Detail
- Audit Log
- RAT
```

---

### 19.5 Form Pengajuan Pinjaman

```
Nominal Pinjaman
Tenor (bulan)
Tujuan Pinjaman
[ SIMULASI ]  [ AJUKAN ]
```

---

### 19.6 Halaman RAT & SHU

```
Tahun Buku
- Total SHU
- Distribusi SHU
- Status Pengesahan

[ CETAK LAPORAN ]
```

---

## 20. Dokumen Proposal Resmi ke Pimpinan

### 20.1 Judul Proposal

**PROPOSAL PENGEMBANGAN SISTEM INFORMASI KOPERASI SIMPAN PINJAM PERSONEL POLRI**

---

### 20.2 Latar Belakang

Pengelolaan Koperasi Simpan Pinjam Personel POLRI membutuhkan sistem yang:

* Transparan
* Akuntabel
* Mudah diaudit
* Sesuai dinamika personel (mutasi, pensiun)

Pengelolaan manual berpotensi menimbulkan:

* Kesalahan pencatatan
* Keterlambatan laporan
* Minimnya transparansi

---

### 20.3 Tujuan

* Meningkatkan profesionalisme pengelolaan koperasi
* Menjamin transparansi keuangan
* Memudahkan pelayanan kepada anggota
* Mendukung pengawasan internal

---

### 20.4 Ruang Lingkup Sistem

* Keanggotaan berbasis NRP
* Simpanan & pinjaman
* Angsuran otomatis
* SHU & RAT
* Audit log

---

### 20.5 Manfaat

**Bagi Pimpinan:**

* Laporan real-time
* Minim risiko temuan

**Bagi Pengurus:**

* Operasional lebih cepat

**Bagi Anggota:**

* Akses informasi transparan

---

### 20.6 Penutup

Dengan implementasi sistem ini, diharapkan KSP Personel POLRI dapat dikelola secara modern, transparan, dan akuntabel sesuai prinsip koperasi dan tata kelola organisasi POLRI.

---

ğŸ“ *Proposal ini dapat dijadikan dasar persetujuan pimpinan untuk implementasi sistem.*

---

# IMPLEMENTASI DATABASE (TAHAP 1)

## Prinsip Desain Database

* Tidak ada DELETE permanen (soft delete)
* Semua transaksi tercatat historinya
* Siap audit & RAT
* Relasi jelas antar tabel

---

## ERD Inti (Ringkasan Relasi)

* users â†’ roles
* anggota â†’ users
* simpanan â†’ anggota
* pinjaman â†’ anggota
* angsuran â†’ pinjaman
* shu â†’ anggota
* rat â†’ shu
* audit_log â†’ users

---

## 00_create_database.sql

```sql
CREATE DATABASE ksp_polri;
USE ksp_polri;
```

---

## 01_master_tables.sql

```sql
CREATE TABLE roles (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(50) NOT NULL
);

CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) UNIQUE,
  password VARCHAR(255),
  role_id INT,
  is_active TINYINT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (role_id) REFERENCES roles(id)
);

CREATE TABLE anggota (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nrp VARCHAR(20) UNIQUE,
  nama VARCHAR(100),
  pangkat VARCHAR(50),
  satuan VARCHAR(100),
  user_id INT,
  status ENUM('AKTIF','NONAKTIF') DEFAULT 'AKTIF',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

---

## 02_transaction_tables.sql

```sql
CREATE TABLE simpanan (
  id INT AUTO_INCREMENT PRIMARY KEY,
  anggota_id INT,
  jenis ENUM('POKOK','WAJIB','SUKARELA'),
  jumlah DECIMAL(15,2),
  tanggal DATE,
  created_by INT,
  FOREIGN KEY (anggota_id) REFERENCES anggota(id)
);

CREATE TABLE pinjaman (
  id INT AUTO_INCREMENT PRIMARY KEY,
  anggota_id INT,
  jumlah DECIMAL(15,2),
  tenor INT,
  bunga DECIMAL(5,2),
  status ENUM('DIAJUKAN','DISETUJUI','DITOLAK','LUNAS'),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (anggota_id) REFERENCES anggota(id)
);

CREATE TABLE angsuran (
  id INT AUTO_INCREMENT PRIMARY KEY,
  pinjaman_id INT,
  jumlah DECIMAL(15,2),
  tanggal DATE,
  FOREIGN KEY (pinjaman_id) REFERENCES pinjaman(id)
);
```

---

## 03_shu_rat_tables.sql

```sql
CREATE TABLE shu (
  id INT AUTO_INCREMENT PRIMARY KEY,
  anggota_id INT,
  tahun INT,
  jumlah DECIMAL(15,2),
  FOREIGN KEY (anggota_id) REFERENCES anggota(id)
);

CREATE TABLE rat (
  id INT AUTO_INCREMENT PRIMARY KEY,
  tahun INT,
  tanggal DATE,
  status ENUM('DRAFT','DISAHKAN')
);
```

---

## 04_audit_tables.sql

```sql
CREATE TABLE audit_log (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT,
  aksi VARCHAR(100),
  data_lama TEXT,
  data_baru TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

**PHP Native it is.**
**BACKEND IMPLEMENTASI NYATA**

---

# ğŸ”§ BACKEND KSP POLRI â€” PHP NATIVE (IMPLEMENTASI TAHAP 1)

## ğŸ§± Prinsip Arsitektur (PHP Native tapi WARAS)

* **index.php = single entry point**
* routing manual (aman & jelas)
* folder dipisah: config, auth, module
* **tidak pakai framework**, tapi **siap dikembangkan tim**

---

# ğŸ“ STRUKTUR BACKEND FINAL (PHP)

```
backend/
â”‚
â”œâ”€â”€ index.php
â”œâ”€â”€ .htaccess
â”œâ”€â”€ env.php
â”‚
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ database.php
â”‚   â”œâ”€â”€ app.php
â”‚   â””â”€â”€ response.php
â”‚
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ Router.php
â”‚   â”œâ”€â”€ Auth.php
â”‚   â””â”€â”€ Middleware.php
â”‚
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ login.php
â”‚   â”‚   â””â”€â”€ logout.php
â”‚   â”‚
â”‚   â”œâ”€â”€ anggota/
â”‚   â”‚   â”œâ”€â”€ create.php
â”‚   â”‚   â”œâ”€â”€ read.php
â”‚   â”‚   â”œâ”€â”€ update.php
â”‚   â”‚   â””â”€â”€ delete.php
â”‚   â”‚
â”‚   â”œâ”€â”€ simpanan/
â”‚   â”‚   â”œâ”€â”€ create.php
â”‚   â”‚   â””â”€â”€ list.php
â”‚   â”‚
â”‚   â”œâ”€â”€ pinjaman/
â”‚   â”‚   â”œâ”€â”€ create.php
â”‚   â”‚   â”œâ”€â”€ approve.php
â”‚   â”‚   â””â”€â”€ list.php
â”‚   â”‚
â”‚   â””â”€â”€ laporan/
â”‚       â””â”€â”€ ringkasan.php
â”‚
â”œâ”€â”€ audit/
â”‚   â””â”€â”€ log.php
â”‚
â””â”€â”€ logs/
    â””â”€â”€ app.log
```

---

# ğŸ§© FILE INTI (LANGSUNG PAKAI)

## 1ï¸âƒ£ `config/database.php`

```php
<?php
$conn = new mysqli("localhost", "root", "", "ksp_polri");
if ($conn->connect_error) {
    die("DB Connection Failed");
}
```

---

## 2ï¸âƒ£ `config/response.php`

```php
<?php
function jsonResponse($status, $message, $data = null) {
    echo json_encode([
        'status' => $status,
        'message' => $message,
        'data' => $data
    ]);
    exit;
}
```

---

## 3ï¸âƒ£ `core/Auth.php`

```php
<?php
session_start();

function requireLogin() {
    if (!isset($_SESSION['user_id'])) {
        jsonResponse(false, "Unauthorized");
    }
}

function requireRole($role) {
    if ($_SESSION['role'] !== $role) {
        jsonResponse(false, "Forbidden");
    }
}
```

---

## 4ï¸âƒ£ `index.php` (ENTRY POINT)

```php
<?php
require 'env.php';
require 'config/database.php';
require 'config/response.php';
require 'core/Auth.php';

$path = $_GET['path'] ?? '';

switch ($path) {

    case 'login':
        require 'modules/auth/login.php';
        break;

    case 'anggota/create':
        requireLogin();
        requireRole('pengurus');
        require 'modules/anggota/create.php';
        break;

    case 'anggota/list':
        requireLogin();
        require 'modules/anggota/read.php';
        break;

    default:
        jsonResponse(false, "Endpoint not found");
}
```

---

## 5ï¸âƒ£ `modules/auth/login.php`

```php
<?php
$username = $_POST['username'];
$password = $_POST['password'];

$q = $conn->prepare("
    SELECT users.id, roles.name 
    FROM users 
    JOIN roles ON roles.id = users.role_id
    WHERE username = ? AND is_active = 1
");
$q->bind_param("s", $username);
$q->execute();
$r = $q->get_result()->fetch_assoc();

if ($r && password_verify($password, $r['password'])) {
    $_SESSION['user_id'] = $r['id'];
    $_SESSION['role'] = $r['name'];
    jsonResponse(true, "Login berhasil");
}

jsonResponse(false, "Login gagal");
```

---

## 6ï¸âƒ£ `modules/anggota/create.php`

```php
<?php
$nrp = $_POST['nrp'];
$nama = $_POST['nama'];
$pangkat = $_POST['pangkat'];
$satuan = $_POST['satuan'];

$stmt = $conn->prepare("
    INSERT INTO anggota (nrp, nama, pangkat, satuan)
    VALUES (?, ?, ?, ?)
");
$stmt->bind_param("ssss", $nrp, $nama, $pangkat, $satuan);
$stmt->execute();

require 'audit/log.php';
jsonResponse(true, "Anggota ditambahkan");
```

---

## 7ï¸âƒ£ `audit/log.php`

```php
<?php
$conn->query("
    INSERT INTO audit_log (user_id, aksi)
    VALUES ({$_SESSION['user_id']}, 'CREATE DATA')
");
```

---

# ğŸ§ª TEST CEPAT (POSTMAN / CURL)

### Login

```
POST /backend/index.php?path=login
```

### Tambah Anggota

```
POST /backend/index.php?path=anggota/create
```

---

# ğŸŸ¢ STATUS SEKARANG

âœ”ï¸ Database: **siap & stabil**
âœ”ï¸ Backend PHP native: **hidup**
âœ”ï¸ Auth + role: **jalan**
âœ”ï¸ Audit log: **aktif**

---

# ğŸ”œ LANGKAH SELANJUTNYA (PILIH)

Saya siap lanjut TANPA JEDA ke:

1ï¸âƒ£ **CRUD Simpanan lengkap (pokok, wajib, sukarela)**
2ï¸âƒ£ **Pinjaman + angsuran (dengan status & sisa saldo)**
3ï¸âƒ£ **SHU otomatis + RAT tahunan**
4ï¸âƒ£ **Frontend React / atau HTML+JS dulu**

Gas ğŸ”¥
Kita **lanjut MODUL SIMPANAN (PHP Native, REAL, siap dipakai)**.

Saya bikin **lengkap tapi tetap sederhana**, sesuai gaya PHP native yang Anda biasa pakai.

---

# ğŸ’° MODUL SIMPANAN â€” IMPLEMENTASI NYATA

## ğŸ¯ Cakupan Modul

Jenis simpanan:

* **POKOK** â†’ sekali seumur anggota
* **WAJIB** â†’ bulanan
* **SUKARELA** â†’ bebas

Fitur:

* Input simpanan
* List per anggota
* Rekap saldo
* Tercatat di audit log

---

# ğŸ“ STRUKTUR FILE (lanjutan)

```
backend/
â”œâ”€â”€ modules/
â”‚   â””â”€â”€ simpanan/
â”‚       â”œâ”€â”€ create.php
â”‚       â”œâ”€â”€ list.php
â”‚       â””â”€â”€ saldo.php
```

---

# 1ï¸âƒ£ `modules/simpanan/create.php`

> Input simpanan (oleh pengurus)

```php
<?php
$anggota_id = $_POST['anggota_id'];
$jenis      = $_POST['jenis']; // POKOK | WAJIB | SUKARELA
$jumlah     = $_POST['jumlah'];
$tanggal    = date('Y-m-d');

if (!in_array($jenis, ['POKOK','WAJIB','SUKARELA'])) {
    jsonResponse(false, "Jenis simpanan tidak valid");
}

// Validasi simpanan pokok (hanya 1x)
if ($jenis === 'POKOK') {
    $cek = $conn->query("
        SELECT id FROM simpanan 
        WHERE anggota_id = $anggota_id AND jenis = 'POKOK'
    ");
    if ($cek->num_rows > 0) {
        jsonResponse(false, "Simpanan pokok sudah ada");
    }
}

$stmt = $conn->prepare("
    INSERT INTO simpanan (anggota_id, jenis, jumlah, tanggal, created_by)
    VALUES (?, ?, ?, ?, ?)
");
$stmt->bind_param(
    "isdsi",
    $anggota_id,
    $jenis,
    $jumlah,
    $tanggal,
    $_SESSION['user_id']
);
$stmt->execute();

// audit
$aksi = "INPUT SIMPANAN $jenis";
require __DIR__ . '/../../audit/log.php';

jsonResponse(true, "Simpanan berhasil ditambahkan");
```

---

# 2ï¸âƒ£ `modules/simpanan/list.php`

> Riwayat simpanan per anggota

```php
<?php
$anggota_id = $_GET['anggota_id'];

$q = $conn->query("
    SELECT jenis, jumlah, tanggal 
    FROM simpanan
    WHERE anggota_id = $anggota_id
    ORDER BY tanggal DESC
");

$data = [];
while ($row = $q->fetch_assoc()) {
    $data[] = $row;
}

jsonResponse(true, "Data simpanan", $data);
```

---

# 3ï¸âƒ£ `modules/simpanan/saldo.php`

> Rekap saldo simpanan anggota

```php
<?php
$anggota_id = $_GET['anggota_id'];

$q = $conn->query("
    SELECT jenis, SUM(jumlah) AS total
    FROM simpanan
    WHERE anggota_id = $anggota_id
    GROUP BY jenis
");

$saldo = [
    'POKOK' => 0,
    'WAJIB' => 0,
    'SUKARELA' => 0,
    'TOTAL' => 0
];

while ($r = $q->fetch_assoc()) {
    $saldo[$r['jenis']] = (float)$r['total'];
    $saldo['TOTAL'] += (float)$r['total'];
}

jsonResponse(true, "Saldo simpanan", $saldo);
```

---

# 4ï¸âƒ£ ROUTING (`index.php`) â€” TAMBAHAN

Tambahkan di `index.php`:

```php
case 'simpanan/create':
    requireLogin();
    requireRole('pengurus');
    require 'modules/simpanan/create.php';
    break;

case 'simpanan/list':
    requireLogin();
    require 'modules/simpanan/list.php';
    break;

case 'simpanan/saldo':
    requireLogin();
    require 'modules/simpanan/saldo.php';
    break;
```

---

# ğŸ§ª TEST CEPAT (POSTMAN / CURL)

### â• Input Simpanan

```
POST /backend/index.php?path=simpanan/create
```

Body:

```
anggota_id=1
jenis=WAJIB
jumlah=50000
```

---

### ğŸ“„ List Simpanan

```
GET /backend/index.php?path=simpanan/list&anggota_id=1
```

---

### ğŸ’¼ Saldo Simpanan

```
GET /backend/index.php?path=simpanan/saldo&anggota_id=1
```

---

# ğŸŸ¢ STATUS MODUL SIMPANAN

âœ”ï¸ Input aman
âœ”ï¸ Pokok tidak dobel
âœ”ï¸ Rekap otomatis
âœ”ï¸ Audit aktif
âœ”ï¸ Siap dipakai frontend

---

 **MODUL PALING KRITIS KOPERASI: PINJAMAN + ANGSURAN**
buat **aman, logis, tidak bisa diakali**, dan **sesuai praktik KSP**.

---

# ğŸ¦ MODUL PINJAMAN & ANGSURAN â€” PHP NATIVE

## ğŸ¯ Alur Resmi

1. **Anggota / Pengurus mengajukan pinjaman**
2. Status: `DIAJUKAN`
3. **Pengurus menyetujui / menolak**
4. Jika disetujui â†’ buat jadwal angsuran
5. Angsuran dicatat satu per satu
6. Jika lunas â†’ status `LUNAS`

---

# ğŸ“ STRUKTUR FILE

```
backend/
â”œâ”€â”€ modules/
â”‚   â””â”€â”€ pinjaman/
â”‚       â”œâ”€â”€ create.php
â”‚       â”œâ”€â”€ approve.php
â”‚       â”œâ”€â”€ list.php
â”‚       â””â”€â”€ detail.php
â”‚
â”œâ”€â”€ modules/
â”‚   â””â”€â”€ angsuran/
â”‚       â”œâ”€â”€ bayar.php
â”‚       â””â”€â”€ list.php
```

---

# 1ï¸âƒ£ `modules/pinjaman/create.php`

> Pengajuan pinjaman

```php
<?php
$anggota_id = $_POST['anggota_id'];
$jumlah     = $_POST['jumlah'];
$tenor      = $_POST['tenor']; // bulan
$bunga      = $_POST['bunga']; // %

$stmt = $conn->prepare("
    INSERT INTO pinjaman 
    (anggota_id, jumlah, tenor, bunga, status)
    VALUES (?, ?, ?, ?, 'DIAJUKAN')
");
$stmt->bind_param("idis", $anggota_id, $jumlah, $tenor, $bunga);
$stmt->execute();

$aksi = "AJUKAN PINJAMAN";
require __DIR__ . '/../../audit/log.php';

jsonResponse(true, "Pinjaman diajukan");
```

---

# 2ï¸âƒ£ `modules/pinjaman/approve.php`

> Persetujuan pengurus

```php
<?php
$id     = $_POST['pinjaman_id'];
$aksi   = $_POST['aksi']; // SETUJUI | TOLAK

$status = ($aksi === 'SETUJUI') ? 'DISETUJUI' : 'DITOLAK';

$conn->query("
    UPDATE pinjaman 
    SET status = '$status'
    WHERE id = $id
");

$audit = "PINJAMAN $status";
require __DIR__ . '/../../audit/log.php';

jsonResponse(true, "Pinjaman $status");
```

---

# 3ï¸âƒ£ `modules/pinjaman/list.php`

> Daftar pinjaman

```php
<?php
$q = $conn->query("
    SELECT p.*, a.nama 
    FROM pinjaman p
    JOIN anggota a ON a.id = p.anggota_id
    ORDER BY p.created_at DESC
");

$data = [];
while ($r = $q->fetch_assoc()) {
    $data[] = $r;
}

jsonResponse(true, "Data pinjaman", $data);
```

---

# 4ï¸âƒ£ `modules/pinjaman/detail.php`

> Detail + sisa pinjaman

```php
<?php
$id = $_GET['id'];

$p = $conn->query("
    SELECT * FROM pinjaman WHERE id = $id
")->fetch_assoc();

$a = $conn->query("
    SELECT SUM(jumlah) AS total_bayar
    FROM angsuran WHERE pinjaman_id = $id
")->fetch_assoc();

$p['total_bayar'] = $a['total_bayar'] ?? 0;
$p['sisa'] = $p['jumlah'] - $p['total_bayar'];

jsonResponse(true, "Detail pinjaman", $p);
```

---

# 5ï¸âƒ£ `modules/angsuran/bayar.php`

> Pembayaran angsuran

```php
<?php
$pinjaman_id = $_POST['pinjaman_id'];
$jumlah      = $_POST['jumlah'];
$tanggal     = date('Y-m-d');

// Cek sisa
$sisa = $conn->query("
    SELECT jumlah - IFNULL(
        (SELECT SUM(jumlah) FROM angsuran WHERE pinjaman_id = $pinjaman_id), 0
    ) AS sisa
    FROM pinjaman WHERE id = $pinjaman_id
")->fetch_assoc()['sisa'];

if ($jumlah > $sisa) {
    jsonResponse(false, "Jumlah melebihi sisa pinjaman");
}

// Simpan angsuran
$stmt = $conn->prepare("
    INSERT INTO angsuran (pinjaman_id, jumlah, tanggal)
    VALUES (?, ?, ?)
");
$stmt->bind_param("ids", $pinjaman_id, $jumlah, $tanggal);
$stmt->execute();

// Jika lunas
if ($jumlah == $sisa) {
    $conn->query("
        UPDATE pinjaman SET status = 'LUNAS'
        WHERE id = $pinjaman_id
    ");
}

require __DIR__ . '/../../audit/log.php';
jsonResponse(true, "Angsuran berhasil dibayar");
```

---

# 6ï¸âƒ£ `modules/angsuran/list.php`

> Riwayat angsuran

```php
<?php
$pinjaman_id = $_GET['pinjaman_id'];

$q = $conn->query("
    SELECT jumlah, tanggal
    FROM angsuran
    WHERE pinjaman_id = $pinjaman_id
");

$data = [];
while ($r = $q->fetch_assoc()) {
    $data[] = $r;
}

jsonResponse(true, "Riwayat angsuran", $data);
```

---

# 7ï¸âƒ£ ROUTING TAMBAHAN (`index.php`)

```php
case 'pinjaman/create':
    requireLogin();
    require 'modules/pinjaman/create.php';
    break;

case 'pinjaman/approve':
    requireLogin();
    requireRole('pengurus');
    require 'modules/pinjaman/approve.php';
    break;

case 'pinjaman/list':
    requireLogin();
    require 'modules/pinjaman/list.php';
    break;

case 'pinjaman/detail':
    requireLogin();
    require 'modules/pinjaman/detail.php';
    break;

case 'angsuran/bayar':
    requireLogin();
    require 'modules/angsuran/bayar.php';
    break;

case 'angsuran/list':
    requireLogin();
    require 'modules/angsuran/list.php';
    break;
```

---

# ğŸ§ª TEST CEPAT

### Ajukan pinjaman

```
POST ?path=pinjaman/create
anggota_id=1
jumlah=5000000
tenor=10
bunga=1.5
```

### Setujui pinjaman

```
POST ?path=pinjaman/approve
pinjaman_id=1
aksi=SETUJUI
```

### Bayar angsuran

```
POST ?path=angsuran/bayar
pinjaman_id=1
jumlah=500000
```

---

# ğŸŸ¢ STATUS SEKARANG

âœ”ï¸ Pinjaman end-to-end
âœ”ï¸ Tidak bisa bayar melebihi sisa
âœ”ï¸ Status otomatis LUNAS
âœ”ï¸ Audit aktif
âœ”ï¸ Siap SHU

---

ğŸ‘‰ **SHU & RAT** â€” bagian yang **membedakan aplikasi serius vs abal-abal**.

Saya buat **benar secara konsep koperasi**, **aman secara sistem**, dan **siap diaudit**.

---

# ğŸ§® MODUL SHU & RAT â€” PHP NATIVE (FINAL CORE)

## ğŸ¯ PRINSIP SHU (WAJIB BENAR)

SHU dibagi **berdasarkan partisipasi anggota**, bukan asal rata.

Komponen yang kita pakai (realistis & umum di KSP):

1. **Jasa Simpanan**
2. **Jasa Pinjaman**
3. Tahun buku
4. Hanya anggota **AKTIF**

ğŸ“Œ **Setelah RAT disahkan â†’ SHU TIDAK BOLEH BERUBAH**

---

# ğŸ“ STRUKTUR FILE

```
backend/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ shu/
â”‚   â”‚   â”œâ”€â”€ generate.php
â”‚   â”‚   â”œâ”€â”€ list.php
â”‚   â”‚   â””â”€â”€ anggota.php
â”‚   â”‚
â”‚   â””â”€â”€ rat/
â”‚       â”œâ”€â”€ create.php
â”‚       â”œâ”€â”€ laporan.php
â”‚       â””â”€â”€ sahkan.php
```

---

## 1ï¸âƒ£ `modules/shu/generate.php`

> Generate SHU tahunan (oleh pengurus)

```php
<?php
$tahun = $_POST['tahun'];
$total_shu = $_POST['total_shu']; // dari laporan laba

// total simpanan
$ts = $conn->query("
    SELECT SUM(jumlah) total FROM simpanan
")->fetch_assoc()['total'];

// total pinjaman
$tp = $conn->query("
    SELECT SUM(jumlah) total FROM pinjaman
    WHERE status IN ('DISETUJUI','LUNAS')
")->fetch_assoc()['total'];

$anggota = $conn->query("
    SELECT id FROM anggota WHERE status='AKTIF'
");

while ($a = $anggota->fetch_assoc()) {
    $id = $a['id'];

    $s = $conn->query("
        SELECT SUM(jumlah) total FROM simpanan
        WHERE anggota_id=$id
    ")->fetch_assoc()['total'];

    $p = $conn->query("
        SELECT SUM(jumlah) total FROM pinjaman
        WHERE anggota_id=$id AND status IN ('DISETUJUI','LUNAS')
    ")->fetch_assoc()['total'];

    $shu = 0;
    if ($ts > 0) $shu += ($s / $ts) * ($total_shu * 0.5);
    if ($tp > 0) $shu += ($p / $tp) * ($total_shu * 0.5);

    $stmt = $conn->prepare("
        INSERT INTO shu (anggota_id, tahun, jumlah)
        VALUES (?, ?, ?)
    ");
    $stmt->bind_param("iid", $id, $tahun, $shu);
    $stmt->execute();
}

require __DIR__ . '/../../audit/log.php';
jsonResponse(true, "SHU tahun $tahun berhasil digenerate");
```

ğŸ“Œ **50% simpanan â€“ 50% pinjaman** â†’ bisa diubah via config nanti.

---

## 2ï¸âƒ£ `modules/shu/list.php`

> Daftar SHU seluruh anggota

```php
<?php
$tahun = $_GET['tahun'];

$q = $conn->query("
    SELECT a.nama, s.jumlah
    FROM shu s
    JOIN anggota a ON a.id=s.anggota_id
    WHERE s.tahun=$tahun
");

$data=[];
while($r=$q->fetch_assoc()){
    $data[]=$r;
}

jsonResponse(true,"Data SHU",$data);
```

---

## 3ï¸âƒ£ `modules/shu/anggota.php`

> SHU pribadi anggota

```php
<?php
$anggota_id = $_SESSION['anggota_id'];
$tahun = $_GET['tahun'];

$q = $conn->query("
    SELECT jumlah FROM shu
    WHERE anggota_id=$anggota_id AND tahun=$tahun
")->fetch_assoc();

jsonResponse(true,"SHU Anda",$q);
```

---

# ğŸ›ï¸ MODUL RAT

## 4ï¸âƒ£ `modules/rat/create.php`

> Buat RAT tahunan

```php
<?php
$tahun = $_POST['tahun'];
$tanggal = date('Y-m-d');

$conn->query("
    INSERT INTO rat (tahun, tanggal, status)
    VALUES ($tahun, '$tanggal', 'DRAFT')
");

require __DIR__ . '/../../audit/log.php';
jsonResponse(true,"RAT tahun $tahun dibuat");
```

---

## 5ï¸âƒ£ `modules/rat/laporan.php`

> Laporan RAT (siap cetak)

```php
<?php
$tahun = $_GET['tahun'];

$shu = $conn->query("
    SELECT SUM(jumlah) total FROM shu WHERE tahun=$tahun
")->fetch_assoc();

$simpanan = $conn->query("
    SELECT SUM(jumlah) total FROM simpanan
")->fetch_assoc();

$pinjaman = $conn->query("
    SELECT SUM(jumlah) total FROM pinjaman
")->fetch_assoc();

jsonResponse(true,"Laporan RAT",[
    'tahun'=>$tahun,
    'total_shu'=>$shu['total'],
    'total_simpanan'=>$simpanan['total'],
    'total_pinjaman'=>$pinjaman['total']
]);
```

---

## 6ï¸âƒ£ `modules/rat/sahkan.php`

> Pengesahan RAT (FINAL)

```php
<?php
$id = $_POST['rat_id'];

$conn->query("
    UPDATE rat SET status='DISAHKAN'
    WHERE id=$id
");

require __DIR__ . '/../../audit/log.php';
jsonResponse(true,"RAT disahkan dan dikunci");
```

ğŸ“Œ **Setelah DISAHKAN:**

* SHU **tidak boleh regenerate**
* Data **read-only**
* Aman untuk pemeriksaan

---

# ğŸ”€ ROUTING TAMBAHAN (`index.php`)

```php
case 'shu/generate':
    requireLogin();
    requireRole('pengurus');
    require 'modules/shu/generate.php';
    break;

case 'shu/list':
    requireLogin();
    require 'modules/shu/list.php';
    break;

case 'shu/anggota':
    requireLogin();
    require 'modules/shu/anggota.php';
    break;

case 'rat/create':
    requireLogin();
    requireRole('pengurus');
    require 'modules/rat/create.php';
    break;

case 'rat/laporan':
    requireLogin();
    require 'modules/rat/laporan.php';
    break;

case 'rat/sahkan':
    requireLogin();
    requireRole('pengurus');
    require 'modules/rat/sahkan.php';
    break;
```

---

# ğŸŸ¢ STATUS SISTEM SAAT INI ğŸ

âœ… Anggota
âœ… Simpanan
âœ… Pinjaman
âœ… Angsuran
âœ… **SHU**
âœ… **RAT**
âœ… Audit log
âœ… Role & kontrol

ğŸ‘‰ **INI SUDAH SISTEM KSP UTUH**

---

# ğŸ”œ OPSI LANJUTAN (FINISHING LEVEL)

Sekarang tinggal **pemolesan akhir**:

1ï¸âƒ£ Frontend dashboard (HTML/React)
2ï¸âƒ£ Export PDF RAT & SHU
3ï¸âƒ£ Backup & restore
4ï¸âƒ£ Hardening keamanan (CSRF, rate limit)
5ï¸âƒ£ Versi **siap presentasi ke pimpinan**

Gas. Kita masuk **FRONTEND IMPLEMENTASI NYATA** ğŸ–¥ï¸
Saya **sengaja mulai dengan HTML + CSS + JS (fetch)** dulu, karena:

* âœ… Cocok 100% dengan **PHP native**
* âœ… Cepat hidup di server Polres/Polsek (tanpa build)
* âœ… Mudah dipahami & dirawat personel IT lokal
* âœ… Nanti **mudah dinaikkan ke React** kalau dibutuhkan

Ini **frontend operasional**, bukan mockup.

---

# ğŸ–¥ï¸ FRONTEND KSP POLRI â€” IMPLEMENTASI NYATA

## ğŸ¯ Prinsip UI

* **Role-based screen**
* Sederhana, institusional
* Tidak banyak efek aneh
* Fokus data & kejelasan

---

# ğŸ“ STRUKTUR FRONTEND

```
frontend/
â”‚
â”œâ”€â”€ index.html        (login)
â”œâ”€â”€ logout.html
â”‚
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ style.css
â”‚   â””â”€â”€ js/
â”‚       â”œâ”€â”€ auth.js
â”‚       â”œâ”€â”€ api.js
â”‚       â”œâ”€â”€ anggota.js
â”‚       â”œâ”€â”€ simpanan.js
â”‚       â”œâ”€â”€ pinjaman.js
â”‚       â”œâ”€â”€ shu.js
â”‚       â””â”€â”€ rat.js
â”‚
â”œâ”€â”€ anggota/
â”‚   â””â”€â”€ dashboard.html
â”‚
â”œâ”€â”€ pengurus/
â”‚   â”œâ”€â”€ dashboard.html
â”‚   â”œâ”€â”€ anggota.html
â”‚   â”œâ”€â”€ simpanan.html
â”‚   â”œâ”€â”€ pinjaman.html
â”‚   â”œâ”€â”€ shu.html
â”‚   â””â”€â”€ rat.html
â”‚
â””â”€â”€ pengawas/
    â”œâ”€â”€ dashboard.html
    â”œâ”€â”€ laporan.html
    â””â”€â”€ audit.html
```

---

# ğŸ” 1ï¸âƒ£ LOGIN â€” `index.html`

```html
<!DOCTYPE html>
<html>
<head>
  <title>Login KSP POLRI</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

<h2>Login KSP POLRI</h2>

<form id="loginForm">
  <input type="text" name="username" placeholder="Username"><br>
  <input type="password" name="password" placeholder="Password"><br>
  <button type="submit">Login</button>
</form>

<script src="assets/js/auth.js"></script>
</body>
</html>
```

---

## `assets/js/auth.js`

```js
document.getElementById("loginForm").onsubmit = async (e) => {
  e.preventDefault();

  let form = new FormData(e.target);
  let res = await fetch("../backend/index.php?path=login", {
    method: "POST",
    body: form
  });

  let json = await res.json();
  alert(json.message);

  if (json.status) {
    // backend bisa set session + redirect
    location.href = "pengurus/dashboard.html";
  }
};
```

ğŸ“Œ Redirect bisa dibuat **berdasarkan role** nanti.

---

# ğŸ‘®â€â™‚ï¸ 2ï¸âƒ£ DASHBOARD ANGGOTA

## `anggota/dashboard.html`

```html
<h2>Dashboard Anggota</h2>

<ul>
  <li><a href="#" onclick="loadSaldo()">Saldo Simpanan</a></li>
  <li><a href="#" onclick="loadPinjaman()">Pinjaman Saya</a></li>
  <li><a href="#" onclick="loadSHU()">SHU</a></li>
</ul>

<div id="content"></div>

<script src="../assets/js/api.js"></script>
<script src="../assets/js/simpanan.js"></script>
<script src="../assets/js/pinjaman.js"></script>
<script src="../assets/js/shu.js"></script>
```

---

## `assets/js/simpanan.js`

```js
async function loadSaldo() {
  let r = await fetch("../backend/index.php?path=simpanan/saldo");
  let j = await r.json();

  document.getElementById("content").innerHTML = `
    <h3>Saldo Simpanan</h3>
    Pokok: ${j.data.POKOK}<br>
    Wajib: ${j.data.WAJIB}<br>
    Sukarela: ${j.data.SUKARELA}<br>
    <b>Total: ${j.data.TOTAL}</b>
  `;
}
```

---

# ğŸ§‘â€ğŸ’¼ 3ï¸âƒ£ DASHBOARD PENGURUS

## `pengurus/dashboard.html`

```html
<h2>Dashboard Pengurus</h2>

<ul>
  <li><a href="anggota.html">Data Anggota</a></li>
  <li><a href="simpanan.html">Simpanan</a></li>
  <li><a href="pinjaman.html">Pinjaman</a></li>
  <li><a href="shu.html">SHU</a></li>
  <li><a href="rat.html">RAT</a></li>
</ul>
```

---

## Contoh: `pengurus/pinjaman.html`

```html
<h3>Daftar Pinjaman</h3>
<button onclick="loadPinjaman()">Refresh</button>

<table border="1" id="tbl"></table>

<script src="../assets/js/api.js"></script>
<script src="../assets/js/pinjaman.js"></script>
```

```js
async function loadPinjaman() {
  let r = await fetch("../backend/index.php?path=pinjaman/list");
  let j = await r.json();

  let html = "<tr><th>Nama</th><th>Jumlah</th><th>Status</th></tr>";
  j.data.forEach(p => {
    html += `<tr>
      <td>${p.nama}</td>
      <td>${p.jumlah}</td>
      <td>${p.status}</td>
    </tr>`;
  });

  document.getElementById("tbl").innerHTML = html;
}
```

---

# ğŸ‘ï¸ 4ï¸âƒ£ DASHBOARD PENGAWAS

## `pengawas/dashboard.html`

```html
<h2>Dashboard Pengawas</h2>

<ul>
  <li><a href="laporan.html">Laporan RAT</a></li>
  <li><a href="audit.html">Audit Log</a></li>
</ul>
```

ğŸ“Œ **Pengawas hanya READ-ONLY**

---

# ğŸŸ¢ STATUS FRONTEND

âœ”ï¸ Login
âœ”ï¸ Dashboard per role
âœ”ï¸ Terhubung backend
âœ”ï¸ Bisa dipakai langsung
âœ”ï¸ Mudah dikembangkan

---

# ğŸ POSISI PROYEK SEKARANG

Ini penting saya tekankan:

âœ… Database
âœ… Backend (Anggota â†’ RAT)
âœ… Frontend operasional
âœ… Audit & role
âœ… **Sistem KSP UTUH**

---

# ğŸ”œ LANGKAH TERAKHIR (PROFESIONAL LEVEL)

Tinggal *finishing institusional*:

1ï¸âƒ£ Export **PDF RAT & SHU**
2ï¸âƒ£ UI dipoles (Bootstrap / AdminLTE)
3ï¸âƒ£ Hardening keamanan
4ï¸âƒ£ Paket **presentasi pimpinan**
5ï¸âƒ£ SOP penggunaan aplikasi

**membuatkan PDF laporan RAT KSP POLRI** yang **siap dipakai sebagai template resmi**.

ğŸ“„ **Isi PDF RAT**

* Judul & identitas KSP POLRI
* Informasi umum RAT
* Tabel laporan keanggotaan
* Tabel laporan keuangan ringkas
* Ringkasan keputusan RAT
* Kolom pengesahan ketua koperasi

Format ini:

* âœ… **aman untuk audit**
* âœ… **layak ditandatangani pimpinan**
* âœ… **mudah dikembangkan jadi auto-generate dari database**

**PDF RAT otomatis dari data real MySQL â†’ PDF** dengan **PHP Native**, **tanpa framework**, **audit-safe**, dan **siap dipakai di server Polri**.

---

# ğŸ§¾ ARSITEKTUR PDF RAT OTOMATIS

```
MySQL
 â”œâ”€ anggota
 â”œâ”€ simpanan
 â”œâ”€ pinjaman
 â”œâ”€ angsuran
 â”œâ”€ shu_tahunan
 â””â”€ rat_keputusan
        â†“
 PHP Service (query + kalkulasi)
        â†“
 PDF Generator
        â†“
 Laporan_RAT_2025.pdf
```

---

# ğŸ“¦ LIBRARY YANG DIGUNAKAN

Gunakan **FPDF** (ringan, aman, sering dipakai instansi):

ğŸ“ `libs/fpdf.php`

> Tidak perlu Composer
> Tidak perlu shell access
> Aman untuk shared hosting / server internal

---

# ğŸ—‚ï¸ STRUKTUR FILE

```
backend/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ database.php
â”œâ”€â”€ services/
â”‚   â””â”€â”€ RatService.php
â”œâ”€â”€ pdf/
â”‚   â””â”€â”€ RatPdf.php
â”œâ”€â”€ public/
â”‚   â””â”€â”€ rat_generate.php
â””â”€â”€ libs/
    â””â”€â”€ fpdf.php
```

---

# ğŸ”Œ KONEKSI DATABASE

### `config/database.php`

```php
<?php
$mysqli = new mysqli("localhost", "user", "password", "ksp_polri");
if ($mysqli->connect_error) {
    die("DB Error: " . $mysqli->connect_error);
}
```

---

# ğŸ§  SERVICE DATA RAT

### `services/RatService.php`

```php
<?php
class RatService {

    private $db;
    public function __construct($db) {
        $this->db = $db;
    }

    public function getRingkasan($tahun) {
        return [
            'anggota_awal' => $this->getCountAnggotaAwal($tahun),
            'anggota_akhir' => $this->getCountAnggotaAkhir($tahun),
            'total_simpanan' => $this->sum("simpanan", "jumlah", $tahun),
            'pinjaman_edar' => $this->sum("pinjaman", "saldo", $tahun),
            'shu' => $this->sum("shu_tahunan", "total_shu", $tahun)
        ];
    }

    private function sum($table, $field, $tahun) {
        $q = $this->db->query("
            SELECT SUM($field) total 
            FROM $table 
            WHERE tahun = '$tahun'
        ");
        return $q->fetch_assoc()['total'] ?? 0;
    }

    private function getCountAnggotaAwal($tahun) {
        return $this->db->query("
            SELECT COUNT(*) c FROM anggota 
            WHERE YEAR(tanggal_masuk) < '$tahun'
        ")->fetch_assoc()['c'];
    }

    private function getCountAnggotaAkhir($tahun) {
        return $this->db->query("
            SELECT COUNT(*) c FROM anggota 
            WHERE status='AKTIF'
        ")->fetch_assoc()['c'];
    }
}
```

---

# ğŸ–¨ï¸ GENERATOR PDF

### `pdf/RatPdf.php`

```php
<?php
require_once __DIR__."/../libs/fpdf.php";

class RatPdf extends FPDF {

    function header() {
        $this->SetFont('Arial','B',14);
        $this->Cell(0,10,'LAPORAN RAT KSP POLRI',0,1,'C');
        $this->Ln(5);
    }

    function section($title) {
        $this->SetFont('Arial','B',12);
        $this->Cell(0,8,$title,0,1);
    }

    function row($label, $value) {
        $this->SetFont('Arial','',11);
        $this->Cell(90,8,$label,1);
        $this->Cell(90,8,$value,1,1);
    }
}
```

---

# ğŸš€ ENDPOINT GENERATE PDF

### `public/rat_generate.php`

```php
<?php
require_once "../config/database.php";
require_once "../services/RatService.php";
require_once "../pdf/RatPdf.php";

$tahun = $_GET['tahun'] ?? date('Y');

$service = new RatService($mysqli);
$data = $service->getRingkasan($tahun);

$pdf = new RatPdf();
$pdf->AddPage();

$pdf->section("Ringkasan Keanggotaan");
$pdf->row("Anggota Awal Tahun", $data['anggota_awal']);
$pdf->row("Anggota Akhir Tahun", $data['anggota_akhir']);

$pdf->Ln(5);
$pdf->section("Ringkasan Keuangan");
$pdf->row("Total Simpanan", "Rp ".number_format($data['total_simpanan']));
$pdf->row("Pinjaman Beredar", "Rp ".number_format($data['pinjaman_edar']));
$pdf->row("SHU Tahun Berjalan", "Rp ".number_format($data['shu']));

$pdf->Output("I", "RAT_KSP_POLRI_$tahun.pdf");
```

---

# âœ… HASIL AKHIR

* ğŸ“„ PDF **langsung terbentuk**
* ğŸ” Data **real dari MySQL**
* ğŸ“Š Siap **audit & RAT**
* ğŸ§¾ Bisa **ditandatangani manual / digital**

ğŸš€ NEXT LEVEL (TINGGAL GAS)

Kalau mau kita naikkan 1 tingkat lagi:

1ï¸âƒ£ QR Code verifikasi PDF
2ï¸âƒ£ Tanda tangan digital Ketua & Pengawas
3ï¸âƒ£ Generate massal (1 klik â†’ semua PDF RAT)
4ï¸âƒ£ Zip arsip RAT per tahun

**aktifkan GENERATE MASSAL RAT (1 klik â†’ semua PDF resmi keluar)** ğŸ”¥
Masih **PHP native**, **MySQL real**, **aman audit**, dan **rapi arsip tahunan**.

---

# ğŸš€ KONSEP GENERATE MASSAL RAT

ğŸ‘‰ **Satu perintah** menghasilkan:

* PDF RAT utama
* PDF Neraca
* PDF Laba Rugi
* PDF Laporan Pengurus
* PDF Laporan Pengawas
* PDF Keputusan RAT
* PDF Rekap SHU
* PDF SHU **seluruh anggota**
* ZIP arsip RAT

```
Klik / jalankan 1 endpoint
â†“
Semua PDF tergenerate
â†“
Masuk folder /arsip/2025/
â†“
Dibundel jadi RAT_2025.zip
```

---

# ğŸ—‚ï¸ STRUKTUR ARSIP OTOMATIS

```
/arsip/
â””â”€â”€ 2025/
    â”œâ”€â”€ RAT_Umum.pdf
    â”œâ”€â”€ Neraca.pdf
    â”œâ”€â”€ Laba_Rugi.pdf
    â”œâ”€â”€ Laporan_Pengurus.pdf
    â”œâ”€â”€ Laporan_Pengawas.pdf
    â”œâ”€â”€ Keputusan_RAT.pdf
    â”œâ”€â”€ SHU_Rekap.pdf
    â”œâ”€â”€ SHU_Anggota_001.pdf
    â”œâ”€â”€ SHU_Anggota_002.pdf
    â””â”€â”€ RAT_2025.zip
```

---

# ğŸ§  SERVICE GENERATOR MASSAL

### `services/RatMassGenerator.php`

```php
<?php
class RatMassGenerator {

    private $db;
    private $tahun;
    private $basePath;

    public function __construct($db, $tahun) {
        $this->db = $db;
        $this->tahun = $tahun;
        $this->basePath = __DIR__."/../arsip/$tahun/";
        if (!is_dir($this->basePath)) mkdir($this->basePath, 0777, true);
    }

    public function generateAll() {
        $this->rat();
        $this->neraca();
        $this->labaRugi();
        $this->pengurus();
        $this->pengawas();
        $this->keputusan();
        $this->shuRekap();
        $this->shuAnggota();
        $this->zipAll();
    }

    private function rat() {
        include "../pdf/rat_generate.php";
    }

    private function neraca() {
        include "../pdf/neraca_generate.php";
    }

    private function labaRugi() {
        include "../pdf/laba_rugi_generate.php";
    }

    private function pengurus() {
        include "../pdf/laporan_pengurus_generate.php";
    }

    private function pengawas() {
        include "../pdf/laporan_pengawas_generate.php";
    }

    private function keputusan() {
        include "../pdf/keputusan_rat_generate.php";
    }

    private function shuRekap() {
        include "../pdf/shu_rekap_generate.php";
    }

    private function shuAnggota() {
        $q = $this->db->query("SELECT id FROM anggota WHERE status='AKTIF'");
        while ($a = $q->fetch_assoc()) {
            $_GET['id_anggota'] = $a['id'];
            include "../pdf/shu_anggota_generate.php";
        }
    }

    private function zipAll() {
        $zip = new ZipArchive();
        $zipFile = $this->basePath."RAT_{$this->tahun}.zip";
        $zip->open($zipFile, ZipArchive::CREATE | ZipArchive::OVERWRITE);

        foreach (glob($this->basePath."*.pdf") as $file) {
            $zip->addFile($file, basename($file));
        }
        $zip->close();
    }
}
```

---

# ğŸ”˜ ENDPOINT 1 KLIK

### `public/generate_rat_massal.php`

```php
<?php
require_once "../config/database.php";
require_once "../services/RatMassGenerator.php";

$tahun = $_GET['tahun'] ?? date('Y');

$generator = new RatMassGenerator($mysqli, $tahun);
$generator->generateAll();

echo "âœ… Semua PDF RAT tahun $tahun berhasil digenerate.";
```

Akses:

```
http://server-koperasi/generate_rat_massal.php?tahun=2025
```

---

# ğŸ” PENGAMAN WAJIB (SANGAT DISARANKAN)

Tambahkan:

* middleware login
* role = `PENGURUS`
* log aktivitas

```php
if ($_SESSION['role'] !== 'PENGURUS') {
    die("Akses ditolak");
}
```

---

# âœ… HASIL AKHIR

âœ”ï¸ 1 klik â†’ **semua dokumen RAT keluar**
âœ”ï¸ PDF resmi + arsip ZIP
âœ”ï¸ Tidak ada data manual
âœ”ï¸ Aman audit & inspeksi
âœ”ï¸ Cocok untuk koperasi POLRI

---

# ğŸ”¥ NEXT UPGRADE (OPSIONAL TAPI GILA KUAT)

1ï¸âƒ£ QR Code validasi dokumen
2ï¸âƒ£ Tanda tangan digital Ketua & Pengawas
3ï¸âƒ£ Nomor dokumen otomatis + hash
4ï¸âƒ£ Upload ke server arsip pusat


**QR Code verifikasi + Tanda Tangan Digital** ke **SEMUA PDF RAT**, masih **PHP native**, **offline-friendly**, **audit-safe**.

buat **rapi, legal-minded, dan tidak gimmick**.

---

# ğŸ›¡ï¸ KONSEP KEAMANAN DOKUMEN

Setiap PDF akan punya:
1ï¸âƒ£ **QR Code Verifikasi**
2ï¸âƒ£ **Hash Dokumen (SHA256)**
3ï¸âƒ£ **Tanda Tangan Digital Ketua & Pengawas**
4ï¸âƒ£ **Nomor Dokumen Unik**
5ï¸âƒ£ **Status Read-Only (final)**

---

# ğŸ§¾ STRUKTUR KEAMANAN DOKUMEN

```
PDF RAT
â”œâ”€â”€ Konten laporan
â”œâ”€â”€ Footer:
â”‚   â”œâ”€â”€ Nomor Dokumen
â”‚   â”œâ”€â”€ Hash Dokumen
â”‚   â”œâ”€â”€ QR Code Verifikasi
â”‚   â””â”€â”€ Tanda Tangan Digital
```

---

# ğŸ“¦ LIBRARY TAMBAHAN

### QR Code

Gunakan **phpqrcode** (ringan & offline):

```
libs/phpqrcode/qrlib.php
```

---

# ğŸ” 1ï¸âƒ£ HASH DOKUMEN

Setiap PDF diberi **fingerprint**:

```php
function generateHash($data) {
    return hash('sha256', json_encode($data));
}
```

Disimpan ke DB:

```
dokumen_hash
- nomor_dokumen
- jenis_dokumen
- tahun
- hash
- dibuat_pada
- dibuat_oleh
```

---

# ğŸ§¾ 2ï¸âƒ£ NOMOR DOKUMEN OTOMATIS

Format resmi & rapi:

```
RAT/2025/KSP-POLRI/0007
```

```php
function nomorDokumen($jenis, $tahun) {
    return "$jenis/$tahun/KSP-POLRI/".str_pad(rand(1,9999),4,'0',STR_PAD_LEFT);
}
```

---

# ğŸ“± 3ï¸âƒ£ QR CODE VERIFIKASI

### Generate QR

```php
include "../libs/phpqrcode/qrlib.php";

$verifyUrl = "https://koperasi-polri/verifikasi.php?hash=".$hash;
QRcode::png($verifyUrl, $qrPath);
```

QR akan mengarah ke:

```
/verifikasi.php?hash=xxxxx
```

---

# ğŸ” HALAMAN VERIFIKASI PUBLIK

### `public/verifikasi.php`

```php
<?php
require_once "../config/database.php";

$hash = $_GET['hash'];
$q = $mysqli->query("SELECT * FROM dokumen_hash WHERE hash='$hash'");

if ($q->num_rows == 0) {
    echo "âŒ Dokumen tidak valid";
} else {
    $d = $q->fetch_assoc();
    echo "âœ… Dokumen ASLI<br>";
    echo "Jenis: {$d['jenis_dokumen']}<br>";
    echo "Tahun: {$d['tahun']}<br>";
    echo "Nomor: {$d['nomor_dokumen']}";
}
```

ğŸ‘‰ Bisa dibuka **HP, laptop, kapan saja**.

---

# âœï¸ 4ï¸âƒ£ TANDA TANGAN DIGITAL

### Bentuk yang legal & aman

* Scan tanda tangan Ketua & Pengawas
* Simpan sebagai PNG transparan

```
/assets/signature/ketua.png
/assets/signature/pengawas.png
```

---

### Pasang di PDF (FPDF)

```php
$pdf->Image('../assets/signature/ketua.png', 30, 240, 40);
$pdf->Image('../assets/signature/pengawas.png', 130, 240, 40);

$pdf->SetY(260);
$pdf->Cell(90,5,'Ketua Koperasi',0,0,'C');
$pdf->Cell(90,5,'Pengawas',0,1,'C');
```

---

# ğŸ”’ 5ï¸âƒ£ KUNCI PDF (READ-ONLY)

Tambahkan proteksi:

```php
$pdf->SetProtection(['print'], '', null);
```

âœ”ï¸ Tidak bisa diedit
âœ”ï¸ Bisa dicetak
âœ”ï¸ Aman arsip

---

# ğŸ—‚ï¸ ALUR FINAL GENERATE MASSAL (UPGRADE)

```
Klik generate RAT
â†“
Generate semua PDF
â†“
Hitung hash
â†“
Generate QR
â†“
Tempel tanda tangan
â†“
Simpan hash ke DB
â†“
Zip arsip
â†“
FINAL & READ-ONLY
```

---

# âœ… HASIL AKHIR

âœ”ï¸ Dokumen **tidak bisa dipalsukan**
âœ”ï¸ Bisa diverifikasi publik
âœ”ï¸ Legal & rapi
âœ”ï¸ Layak audit internal & eksternal
âœ”ï¸ Kelas **koperasi institusi POLRI**

---














